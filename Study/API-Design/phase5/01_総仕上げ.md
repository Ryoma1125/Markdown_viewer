# Phase 5-1: 総仕上げ ～ 実践 API 構築 ～

## 学習目標

この単元を終えると、以下ができるようになります：

- 本番レベルの REST API を設計・構築できる
- GraphQL API を設計・構築できる
- API のベストプラクティスを適用できる

## 総合演習: タスク管理 API

### 要件

```
- ユーザー管理（登録、ログイン、プロフィール）
- プロジェクト管理（CRUD）
- タスク管理（CRUD、ステータス変更）
- コメント機能
```

### ディレクトリ構成

```
task-api/
├── app/
│   ├── __init__.py
│   ├── main.py
│   ├── config.py
│   ├── models/
│   │   ├── __init__.py
│   │   ├── user.py
│   │   ├── project.py
│   │   └── task.py
│   ├── schemas/
│   │   ├── __init__.py
│   │   ├── user.py
│   │   ├── project.py
│   │   └── task.py
│   ├── api/
│   │   ├── __init__.py
│   │   ├── deps.py
│   │   ├── v1/
│   │   │   ├── __init__.py
│   │   │   ├── router.py
│   │   │   ├── users.py
│   │   │   ├── projects.py
│   │   │   └── tasks.py
│   ├── graphql/
│   │   ├── __init__.py
│   │   ├── schema.py
│   │   ├── types.py
│   │   └── resolvers.py
│   ├── core/
│   │   ├── __init__.py
│   │   ├── security.py
│   │   └── exceptions.py
│   └── db/
│       ├── __init__.py
│       └── session.py
├── tests/
├── requirements.txt
└── docker-compose.yml
```

### 実装例

```python
# app/main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from strawberry.fastapi import GraphQLRouter
from app.api.v1.router import api_router
from app.graphql.schema import schema
from app.core.exceptions import setup_exception_handlers

def create_app() -> FastAPI:
    app = FastAPI(
        title="Task Management API",
        description="タスク管理APIのサンプル実装",
        version="1.0.0",
    )
    
    # CORS
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )
    
    # 例外ハンドラー
    setup_exception_handlers(app)
    
    # REST API
    app.include_router(api_router, prefix="/api/v1")
    
    # GraphQL
    graphql_app = GraphQLRouter(schema)
    app.include_router(graphql_app, prefix="/graphql")
    
    return app

app = create_app()
```

```python
# app/schemas/task.py
from pydantic import BaseModel, Field
from typing import Optional, List
from datetime import datetime
from enum import Enum

class TaskStatus(str, Enum):
    TODO = "todo"
    IN_PROGRESS = "in_progress"
    DONE = "done"

class TaskPriority(str, Enum):
    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"

class TaskBase(BaseModel):
    title: str = Field(..., min_length=1, max_length=200)
    description: Optional[str] = None
    status: TaskStatus = TaskStatus.TODO
    priority: TaskPriority = TaskPriority.MEDIUM
    due_date: Optional[datetime] = None

class TaskCreate(TaskBase):
    project_id: int

class TaskUpdate(BaseModel):
    title: Optional[str] = Field(None, min_length=1, max_length=200)
    description: Optional[str] = None
    status: Optional[TaskStatus] = None
    priority: Optional[TaskPriority] = None
    due_date: Optional[datetime] = None
    assignee_id: Optional[int] = None

class TaskResponse(TaskBase):
    id: int
    project_id: int
    creator_id: int
    assignee_id: Optional[int]
    created_at: datetime
    updated_at: datetime
    
    class Config:
        from_attributes = True

class TaskListResponse(BaseModel):
    data: List[TaskResponse]
    meta: "PaginationMeta"
```

```python
# app/api/v1/tasks.py
from fastapi import APIRouter, Depends, Query, status
from typing import List, Optional
from app.schemas.task import (
    TaskCreate, TaskUpdate, TaskResponse, TaskListResponse, TaskStatus
)
from app.api.deps import get_current_user, get_db
from app.models.user import User
from app.core.exceptions import NotFoundError, ForbiddenError

router = APIRouter(prefix="/tasks", tags=["tasks"])

@router.get("", response_model=TaskListResponse)
async def list_tasks(
    project_id: Optional[int] = None,
    status: Optional[TaskStatus] = None,
    assignee_id: Optional[int] = None,
    page: int = Query(1, ge=1),
    limit: int = Query(20, ge=1, le=100),
    db = Depends(get_db),
    current_user: User = Depends(get_current_user),
):
    """
    タスク一覧を取得
    
    フィルタリング:
    - project_id: プロジェクトでフィルタ
    - status: ステータスでフィルタ
    - assignee_id: 担当者でフィルタ
    """
    # 実装
    pass

@router.post("", response_model=TaskResponse, status_code=status.HTTP_201_CREATED)
async def create_task(
    task: TaskCreate,
    db = Depends(get_db),
    current_user: User = Depends(get_current_user),
):
    """新しいタスクを作成"""
    pass

@router.get("/{task_id}", response_model=TaskResponse)
async def get_task(
    task_id: int,
    db = Depends(get_db),
    current_user: User = Depends(get_current_user),
):
    """タスクを取得"""
    pass

@router.patch("/{task_id}", response_model=TaskResponse)
async def update_task(
    task_id: int,
    task: TaskUpdate,
    db = Depends(get_db),
    current_user: User = Depends(get_current_user),
):
    """タスクを更新"""
    pass

@router.delete("/{task_id}", status_code=status.HTTP_204_NO_CONTENT)
async def delete_task(
    task_id: int,
    db = Depends(get_db),
    current_user: User = Depends(get_current_user),
):
    """タスクを削除"""
    pass

@router.post("/{task_id}/assign", response_model=TaskResponse)
async def assign_task(
    task_id: int,
    assignee_id: int,
    db = Depends(get_db),
    current_user: User = Depends(get_current_user),
):
    """タスクを担当者にアサイン"""
    pass
```

```python
# app/graphql/types.py
import strawberry
from typing import List, Optional
from datetime import datetime
from enum import Enum

@strawberry.enum
class TaskStatus(Enum):
    TODO = "todo"
    IN_PROGRESS = "in_progress"
    DONE = "done"

@strawberry.type
class User:
    id: int
    name: str
    email: str

@strawberry.type
class Task:
    id: int
    title: str
    description: Optional[str]
    status: TaskStatus
    due_date: Optional[datetime]
    created_at: datetime
    
    @strawberry.field
    async def creator(self, info) -> User:
        loader = info.context["user_loader"]
        return await loader.load(self.creator_id)
    
    @strawberry.field
    async def assignee(self, info) -> Optional[User]:
        if self.assignee_id:
            loader = info.context["user_loader"]
            return await loader.load(self.assignee_id)
        return None

@strawberry.type
class Project:
    id: int
    name: str
    description: Optional[str]
    
    @strawberry.field
    async def tasks(self, info) -> List[Task]:
        # 実装
        pass
    
    @strawberry.field
    async def owner(self, info) -> User:
        loader = info.context["user_loader"]
        return await loader.load(self.owner_id)
```

## API 設計チェックリスト

```markdown
## REST API
- [ ] 適切な HTTP メソッド使用
- [ ] 一貫した URL 設計
- [ ] 適切なステータスコード
- [ ] ページネーション対応
- [ ] フィルタリング・ソート対応
- [ ] 一貫したエラーレスポンス

## GraphQL
- [ ] 適切な型設計
- [ ] N+1問題対策（DataLoader）
- [ ] ページネーション（Relay形式）
- [ ] エラーハンドリング

## 共通
- [ ] 認証・認可
- [ ] バリデーション
- [ ] ドキュメント
- [ ] テスト
- [ ] ロギング
```

## カリキュラム完了！

おめでとうございます！API 設計のカリキュラムを完了しました。

### 学んだこと

1. **REST 基礎** - HTTP、URL 設計
2. **FastAPI** - CRUD 実装
3. **バリデーション** - Pydantic、エラー処理
4. **認証・認可** - JWT、RBAC
5. **ドキュメント** - OpenAPI、Swagger
6. **GraphQL** - 概念と Strawberry 実装

### 次のステップ

- **gRPC** - 高速なマイクロサービス通信
- **API Gateway** - Kong, AWS API Gateway
- **レート制限** - 負荷対策
- **キャッシュ** - Redis との連携
