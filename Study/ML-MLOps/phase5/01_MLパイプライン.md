# Phase 5-1: ML パイプライン

## 学習目標

この単元を終えると、以下ができるようになります：

- MLflow で実験管理ができる
- モデルのバージョン管理ができる
- 再現性のあるパイプラインを構築できる

## MLOps とは

```mermaid
graph LR
    D[データ] --> E[実験]
    E --> T[訓練]
    T --> V[検証]
    V --> D2[デプロイ]
    D2 --> M[監視]
    M --> D
```

### 課題

| 課題 | 解決策 |
|------|-------|
| 実験の追跡 | MLflow Tracking |
| モデル管理 | MLflow Model Registry |
| 再現性 | MLflow Projects |
| デプロイ | MLflow Models |

## ハンズオン

### 演習1: MLflow 基礎

```bash
pip install mlflow
```

```python
# mlflow_basics.py
import mlflow
import mlflow.sklearn
from sklearn.datasets import load_iris
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import accuracy_score

# データ
iris = load_iris()
X_train, X_test, y_train, y_test = train_test_split(
    iris.data, iris.target, test_size=0.2, random_state=42
)

# MLflow 実験開始
mlflow.set_experiment('iris_classification')

with mlflow.start_run(run_name='random_forest_v1'):
    # パラメータ
    n_estimators = 100
    max_depth = 5
    
    mlflow.log_param('n_estimators', n_estimators)
    mlflow.log_param('max_depth', max_depth)
    
    # 訓練
    model = RandomForestClassifier(
        n_estimators=n_estimators,
        max_depth=max_depth,
        random_state=42
    )
    model.fit(X_train, y_train)
    
    # 評価
    y_pred = model.predict(X_test)
    accuracy = accuracy_score(y_test, y_pred)
    
    mlflow.log_metric('accuracy', accuracy)
    
    # モデル保存
    mlflow.sklearn.log_model(model, 'model')
    
    print(f'Run ID: {mlflow.active_run().info.run_id}')
    print(f'Accuracy: {accuracy:.4f}')

# UI 起動
# mlflow ui
```

### 演習2: 複数実験の比較

```python
# mlflow_experiments.py
import mlflow
import mlflow.sklearn
from sklearn.datasets import load_iris
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier, GradientBoostingClassifier
from sklearn.linear_model import LogisticRegression
from sklearn.metrics import accuracy_score, f1_score

# データ
iris = load_iris()
X_train, X_test, y_train, y_test = train_test_split(
    iris.data, iris.target, test_size=0.2, random_state=42
)

mlflow.set_experiment('model_comparison')

models = {
    'RandomForest': RandomForestClassifier(n_estimators=100, random_state=42),
    'GradientBoosting': GradientBoostingClassifier(n_estimators=100, random_state=42),
    'LogisticRegression': LogisticRegression(max_iter=200, random_state=42)
}

for name, model in models.items():
    with mlflow.start_run(run_name=name):
        # タグ
        mlflow.set_tag('model_type', name)
        
        # 訓練
        model.fit(X_train, y_train)
        y_pred = model.predict(X_test)
        
        # メトリクス
        accuracy = accuracy_score(y_test, y_pred)
        f1 = f1_score(y_test, y_pred, average='macro')
        
        mlflow.log_metric('accuracy', accuracy)
        mlflow.log_metric('f1_score', f1)
        
        # モデル保存
        mlflow.sklearn.log_model(model, 'model')
        
        print(f'{name}: accuracy={accuracy:.4f}, f1={f1:.4f}')
```

### 演習3: 自動ログ

```python
# mlflow_autolog.py
import mlflow
import mlflow.sklearn
from sklearn.datasets import load_iris
from sklearn.model_selection import train_test_split, GridSearchCV
from sklearn.ensemble import RandomForestClassifier

# 自動ログ有効化
mlflow.sklearn.autolog()

# データ
iris = load_iris()
X_train, X_test, y_train, y_test = train_test_split(
    iris.data, iris.target, test_size=0.2, random_state=42
)

# グリッドサーチ
param_grid = {
    'n_estimators': [50, 100, 200],
    'max_depth': [3, 5, 10]
}

grid_search = GridSearchCV(
    RandomForestClassifier(random_state=42),
    param_grid,
    cv=5,
    scoring='accuracy'
)

# 訓練（自動でログされる）
grid_search.fit(X_train, y_train)

print(f'Best params: {grid_search.best_params_}')
print(f'Best score: {grid_search.best_score_:.4f}')
```

### 演習4: モデルレジストリ

```python
# model_registry.py
import mlflow
import mlflow.sklearn
from sklearn.datasets import load_iris
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier

# データ
iris = load_iris()
X_train, X_test, y_train, y_test = train_test_split(
    iris.data, iris.target, test_size=0.2, random_state=42
)

# 訓練
model = RandomForestClassifier(n_estimators=100, random_state=42)
model.fit(X_train, y_train)

# モデル登録
with mlflow.start_run():
    mlflow.sklearn.log_model(
        model,
        'model',
        registered_model_name='IrisClassifier'
    )

# モデル読み込み（バージョン指定）
# loaded_model = mlflow.sklearn.load_model('models:/IrisClassifier/1')
# loaded_model = mlflow.sklearn.load_model('models:/IrisClassifier/Production')

# ステージ変更（UI または API）
from mlflow import MlflowClient

client = MlflowClient()
# client.transition_model_version_stage(
#     name='IrisClassifier',
#     version=1,
#     stage='Production'
# )
```

### 演習5: パイプライン

```python
# ml_pipeline.py
import mlflow
from sklearn.pipeline import Pipeline
from sklearn.preprocessing import StandardScaler
from sklearn.ensemble import RandomForestClassifier
from sklearn.datasets import load_iris
from sklearn.model_selection import train_test_split
import joblib

# データ
iris = load_iris()
X_train, X_test, y_train, y_test = train_test_split(
    iris.data, iris.target, test_size=0.2, random_state=42
)

# パイプライン
pipeline = Pipeline([
    ('scaler', StandardScaler()),
    ('classifier', RandomForestClassifier(n_estimators=100, random_state=42))
])

with mlflow.start_run(run_name='pipeline'):
    # 訓練
    pipeline.fit(X_train, y_train)
    
    # 評価
    accuracy = pipeline.score(X_test, y_test)
    mlflow.log_metric('accuracy', accuracy)
    
    # パイプライン全体を保存
    mlflow.sklearn.log_model(pipeline, 'pipeline')
    
    # アーティファクト保存
    joblib.dump(pipeline, 'pipeline.joblib')
    mlflow.log_artifact('pipeline.joblib')
    
    print(f'Accuracy: {accuracy:.4f}')
```

## 理解度確認

### 問題

MLflow で実験のパラメータを記録するメソッドはどれか。

**A.** mlflow.set_param()

**B.** mlflow.log_param()

**C.** mlflow.record_param()

**D.** mlflow.save_param()

---

### 解答・解説

**正解: B**

`mlflow.log_param()` でパラメータを記録します。`mlflow.log_metric()` でメトリクスを記録します。

```python
mlflow.log_param('learning_rate', 0.01)
mlflow.log_metric('accuracy', 0.95)
```

---

## 次のステップ

ML パイプラインを学びました。次はモデルデプロイを学びましょう。

**次の単元**: [Phase 5-2: モデルデプロイ](./02_モデルデプロイ.md)
