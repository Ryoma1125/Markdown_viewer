# Phase 2-2: データ操作 ～ INSERT, UPDATE, DELETE ～

## 学習目標

この単元を終えると、以下ができるようになります：

- INSERT でデータを追加できる
- UPDATE でデータを更新できる
- DELETE でデータを削除できる
- 安全にデータ操作を行える

## 概念解説

### CRUD 操作

| 操作 | SQL | 説明 |
|------|-----|------|
| Create | INSERT | データ追加 |
| Read | SELECT | データ取得 |
| Update | UPDATE | データ更新 |
| Delete | DELETE | データ削除 |

### AWS で例えると...

| SQL 操作 | DynamoDB |
|----------|----------|
| INSERT | PutItem |
| SELECT | GetItem, Query, Scan |
| UPDATE | UpdateItem |
| DELETE | DeleteItem |

## ハンズオン

### 演習1: INSERT - データ追加

```bash
docker exec -it mysql-practice mysql -u student -pstudentpass practice << 'EOF'
-- 基本的な INSERT
INSERT INTO users (name, email, age, department)
VALUES ('新規太郎', 'new@example.com', 26, '開発部');

-- 確認
SELECT * FROM users WHERE email = 'new@example.com';

-- 複数行を一度に挿入
INSERT INTO users (name, email, age, department) VALUES
    ('テスト1', 'test1@example.com', 24, '営業部'),
    ('テスト2', 'test2@example.com', 28, '人事部'),
    ('テスト3', 'test3@example.com', 31, '開発部');

-- 確認
SELECT * FROM users ORDER BY id DESC LIMIT 4;
EOF
```

### 演習2: INSERT の応用

```bash
docker exec -it mysql-practice mysql -u student -pstudentpass practice << 'EOF'
-- SELECT 結果を INSERT（データ複製）
CREATE TABLE users_backup AS SELECT * FROM users;
SELECT COUNT(*) FROM users_backup;

-- INSERT ... ON DUPLICATE KEY UPDATE（UPSERT）
INSERT INTO users (name, email, age, department)
VALUES ('田中太郎', 'tanaka@example.com', 29, '開発部')
ON DUPLICATE KEY UPDATE age = 29;

-- 確認（age が更新されている）
SELECT * FROM users WHERE email = 'tanaka@example.com';

-- バックアップテーブル削除
DROP TABLE users_backup;
EOF
```

### 演習3: UPDATE - データ更新

```bash
docker exec -it mysql-practice mysql -u student -pstudentpass practice << 'EOF'
-- 単一行の更新
UPDATE users 
SET age = 29 
WHERE id = 1;

-- 確認
SELECT * FROM users WHERE id = 1;

-- 複数列を更新
UPDATE users 
SET age = 33, department = '企画部' 
WHERE email = 'sato@example.com';

-- 確認
SELECT * FROM users WHERE email = 'sato@example.com';

-- 計算による更新
UPDATE users 
SET age = age + 1 
WHERE department = '開発部';

-- 確認
SELECT name, age FROM users WHERE department = '開発部';
EOF
```

### 演習4: DELETE - データ削除

```bash
docker exec -it mysql-practice mysql -u student -pstudentpass practice << 'EOF'
-- テスト用データを確認
SELECT * FROM users WHERE email LIKE 'test%';

-- 条件を指定して削除
DELETE FROM users WHERE email LIKE 'test%';

-- 確認（削除されている）
SELECT * FROM users WHERE email LIKE 'test%';

-- 削除前に件数確認（安全のため）
SELECT COUNT(*) FROM users WHERE email = 'new@example.com';

-- 削除実行
DELETE FROM users WHERE email = 'new@example.com';
EOF
```

### 演習5: 安全なデータ操作

```bash
docker exec -it mysql-practice mysql -u student -pstudentpass practice << 'EOF'
-- ★重要：UPDATE/DELETE 前に必ず SELECT で確認

-- 更新対象を確認
SELECT * FROM users WHERE department = '営業部';

-- 問題なければ UPDATE
UPDATE users SET age = age + 1 WHERE department = '営業部';

-- 削除対象を確認
SELECT * FROM orders WHERE ordered_at < '2024-02-01';

-- 問題なければ DELETE
-- DELETE FROM orders WHERE ordered_at < '2024-02-01';
-- ※今回は実行しない（コメントアウト）

-- LIMIT を使った安全な削除
DELETE FROM orders WHERE ordered_at < '2024-02-01' LIMIT 1;

-- 確認
SELECT * FROM orders;
EOF
```

### 演習6: TRUNCATE と DELETE の違い

```bash
docker exec -it mysql-practice mysql -u student -pstudentpass practice << 'EOF'
-- テスト用テーブル作成
CREATE TABLE delete_test (
    id INT AUTO_INCREMENT PRIMARY KEY,
    value VARCHAR(50)
);

INSERT INTO delete_test (value) VALUES ('A'), ('B'), ('C');
SELECT * FROM delete_test;

-- DELETE：行ごとに削除、AUTO_INCREMENT 維持
DELETE FROM delete_test;
INSERT INTO delete_test (value) VALUES ('D');
SELECT * FROM delete_test;  -- id = 4

-- TRUNCATE：テーブルを初期化、AUTO_INCREMENT リセット
TRUNCATE TABLE delete_test;
INSERT INTO delete_test (value) VALUES ('E');
SELECT * FROM delete_test;  -- id = 1

DROP TABLE delete_test;
EOF
```

## ⚠️ 危険な操作の防止

### やってはいけないこと

```sql
-- ❌ WHERE なしの UPDATE（全行が更新される！）
UPDATE users SET age = 0;

-- ❌ WHERE なしの DELETE（全行が削除される！）
DELETE FROM users;

-- ✅ 必ず WHERE を指定
UPDATE users SET age = 30 WHERE id = 1;
DELETE FROM users WHERE id = 100;
```

### 安全対策

```sql
-- トランザクションを使う
START TRANSACTION;
DELETE FROM users WHERE id = 100;
-- 確認
SELECT * FROM users WHERE id = 100;
-- 問題なければ確定、問題あれば取り消し
COMMIT;  -- または ROLLBACK;
```

## 現場でよくある落とし穴

| 落とし穴 | 説明 | 対策 |
|---------|------|------|
| WHERE 忘れ | 全データが変更/削除される | 必ず WHERE を確認 |
| 条件の間違い | 意図しないデータが対象に | 先に SELECT で確認 |
| バックアップなし | 復旧不可能 | 重要な操作前にバックアップ |

## 理解度確認

### 問題

users テーブルの全データを削除した後、新しく INSERT したレコードの id を 1 から始めたい。最も適切な SQL はどれか。

**A.** `DELETE FROM users;` のみ

**B.** `TRUNCATE TABLE users;`

**C.** `DROP TABLE users;`

**D.** `DELETE FROM users; ALTER TABLE users AUTO_INCREMENT = 1;`

---

### 解答・解説

**正解: B**

- **A.** 誤り。DELETE は行を削除するが AUTO_INCREMENT はリセットされない。
- **B.** 正解。TRUNCATE はテーブルを初期化し、AUTO_INCREMENT もリセットされる。
- **C.** 誤り。DROP はテーブル自体を削除してしまう。
- **D.** 部分的に正しいが、2つのコマンドが必要で効率が悪い。

---

## まとめ

| 操作 | 構文 | 注意点 |
|------|------|--------|
| INSERT | INSERT INTO table (cols) VALUES (vals) | 必須列の確認 |
| UPDATE | UPDATE table SET col=val WHERE 条件 | WHERE 必須 |
| DELETE | DELETE FROM table WHERE 条件 | WHERE 必須 |
| TRUNCATE | TRUNCATE TABLE table | 全削除、復旧不可 |

## 次のステップ

データの追加・更新・削除を学びました。次はテーブルの設計方法を学びましょう。

**次の単元**: [Phase 3-1: テーブル設計](../phase3/01_テーブル設計.md)
