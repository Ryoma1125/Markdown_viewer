# Phase 6: ç·ä»•ä¸Šã’ ï½ å®Ÿè·µãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ ï½

## å­¦ç¿’ç›®æ¨™

ã“ã®å˜å…ƒã‚’çµ‚ãˆã‚‹ã¨ã€ä»¥ä¸‹ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š

- è¦ä»¶ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆãŒã§ãã‚‹
- å®Ÿè·µçš„ãª SQL ã‚’æ›¸ã‘ã‚‹
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’è€ƒæ…®ã—ãŸè¨­è¨ˆãŒã§ãã‚‹

## å®Ÿè·µãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ECã‚µã‚¤ãƒˆã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

### è¦ä»¶

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»èªè¨¼
- å•†å“ã‚«ã‚¿ãƒ­ã‚°ï¼ˆã‚«ãƒ†ã‚´ãƒªä»˜ãï¼‰
- ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒˆ
- æ³¨æ–‡ãƒ»æ±ºæ¸ˆ
- ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½

### ERå›³

```mermaid
erDiagram
    users ||--o{ orders : places
    users ||--o{ reviews : writes
    users ||--o{ cart_items : has
    orders ||--|{ order_items : contains
    products ||--o{ order_items : included_in
    products ||--o{ reviews : receives
    products ||--o{ cart_items : added_to
    products }o--|| categories : belongs_to
    
    users {
        int id PK
        string email UK
        string password_hash
        string name
        datetime created_at
    }
    
    categories {
        int id PK
        string name
        int parent_id FK
    }
    
    products {
        int id PK
        string name
        text description
        decimal price
        int stock
        int category_id FK
    }
    
    orders {
        int id PK
        int user_id FK
        decimal total
        string status
        datetime ordered_at
    }
    
    order_items {
        int id PK
        int order_id FK
        int product_id FK
        int quantity
        decimal price_at_order
    }
```

### ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

```bash
docker exec -it mysql-practice mysql -u student -pstudentpass practice << 'EOF'
-- ECã‚µã‚¤ãƒˆã®ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼
CREATE TABLE ec_users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(100) NOT NULL,
    phone VARCHAR(20),
    address VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_email (email)
);

-- ã‚«ãƒ†ã‚´ãƒªï¼ˆéšå±¤æ§‹é€ ï¼‰
CREATE TABLE ec_categories (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    parent_id INT NULL,
    sort_order INT DEFAULT 0,
    FOREIGN KEY (parent_id) REFERENCES ec_categories(id),
    INDEX idx_parent (parent_id)
);

-- å•†å“
CREATE TABLE ec_products (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    stock INT NOT NULL DEFAULT 0,
    category_id INT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (category_id) REFERENCES ec_categories(id),
    INDEX idx_category (category_id),
    INDEX idx_active_price (is_active, price)
);

-- ã‚«ãƒ¼ãƒˆ
CREATE TABLE ec_cart_items (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    product_id INT NOT NULL,
    quantity INT NOT NULL DEFAULT 1,
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES ec_users(id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES ec_products(id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_product (user_id, product_id)
);

-- æ³¨æ–‡
CREATE TABLE ec_orders (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    subtotal DECIMAL(12,2) NOT NULL,
    tax DECIMAL(12,2) NOT NULL,
    shipping_fee DECIMAL(8,2) DEFAULT 0,
    total DECIMAL(12,2) NOT NULL,
    status ENUM('pending', 'paid', 'shipped', 'delivered', 'cancelled') DEFAULT 'pending',
    shipping_address VARCHAR(500),
    ordered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    shipped_at TIMESTAMP NULL,
    delivered_at TIMESTAMP NULL,
    FOREIGN KEY (user_id) REFERENCES ec_users(id),
    INDEX idx_user (user_id),
    INDEX idx_status (status),
    INDEX idx_ordered_at (ordered_at)
);

-- æ³¨æ–‡æ˜ç´°
CREATE TABLE ec_order_items (
    id INT AUTO_INCREMENT PRIMARY KEY,
    order_id INT NOT NULL,
    product_id INT NOT NULL,
    product_name VARCHAR(200) NOT NULL,
    quantity INT NOT NULL,
    price_at_order DECIMAL(10,2) NOT NULL,
    FOREIGN KEY (order_id) REFERENCES ec_orders(id) ON DELETE CASCADE,
    FOREIGN KEY (product_id) REFERENCES ec_products(id),
    INDEX idx_order (order_id)
);

-- ãƒ¬ãƒ“ãƒ¥ãƒ¼
CREATE TABLE ec_reviews (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    product_id INT NOT NULL,
    rating TINYINT NOT NULL CHECK (rating BETWEEN 1 AND 5),
    title VARCHAR(200),
    content TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES ec_users(id),
    FOREIGN KEY (product_id) REFERENCES ec_products(id),
    UNIQUE KEY uk_user_product (user_id, product_id),
    INDEX idx_product_rating (product_id, rating)
);

SELECT 'ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆå®Œäº†' AS status;
EOF
```

### ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿

```bash
docker exec -it mysql-practice mysql -u student -pstudentpass practice << 'EOF'
-- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥

INSERT INTO ec_users (email, password_hash, name, address) VALUES
    ('user1@example.com', 'hash1', 'ç”°ä¸­å¤ªéƒ', 'æ±äº¬éƒ½æ¸‹è°·åŒº'),
    ('user2@example.com', 'hash2', 'ä½è—¤èŠ±å­', 'å¤§é˜ªåºœå¤§é˜ªå¸‚'),
    ('user3@example.com', 'hash3', 'éˆ´æœ¨ä¸€éƒ', 'æ„›çŸ¥çœŒåå¤å±‹å¸‚');

INSERT INTO ec_categories (id, name, parent_id) VALUES
    (1, 'å®¶é›»', NULL),
    (2, 'ãƒ‘ã‚½ã‚³ãƒ³', 1),
    (3, 'ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³', 1),
    (4, 'ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³', NULL),
    (5, 'ãƒ¡ãƒ³ã‚º', 4),
    (6, 'ãƒ¬ãƒ‡ã‚£ãƒ¼ã‚¹', 4);

INSERT INTO ec_products (name, description, price, stock, category_id) VALUES
    ('ãƒãƒ¼ãƒˆPC A', 'é«˜æ€§èƒ½ãƒãƒ¼ãƒˆPC', 150000, 10, 2),
    ('ãƒãƒ¼ãƒˆPC B', 'ã‚³ã‚¹ãƒ‘æœ€å¼·PC', 80000, 20, 2),
    ('ã‚¹ãƒãƒ› X', 'æœ€æ–°ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³', 120000, 15, 3),
    ('ã‚¹ãƒãƒ› Y', 'ãŠæ‰‹é ƒã‚¹ãƒãƒ›', 50000, 30, 3),
    ('Tã‚·ãƒ£ãƒ„', 'ã‚·ãƒ³ãƒ—ãƒ«Tã‚·ãƒ£ãƒ„', 3000, 100, 5),
    ('ãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹', 'æ˜¥ç‰©ãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹', 8000, 50, 6);

INSERT INTO ec_reviews (user_id, product_id, rating, title, content) VALUES
    (1, 1, 5, 'æœ€é«˜ï¼', 'ã¨ã¦ã‚‚æº€è¶³ã—ã¦ã„ã¾ã™'),
    (2, 1, 4, 'è‰¯ã„', 'æ¦‚ã­æº€è¶³'),
    (1, 3, 5, 'ç´ æ™´ã‚‰ã—ã„', 'ã‚«ãƒ¡ãƒ©ãŒæœ€é«˜'),
    (3, 2, 3, 'æ™®é€š', 'å€¤æ®µç›¸å¿œ');

SELECT 'ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥å®Œäº†' AS status;
EOF
```

### å®Ÿè·µã‚¯ã‚¨ãƒª

```bash
docker exec -it mysql-practice mysql -u student -pstudentpass practice << 'EOF'
-- 1. ã‚«ãƒ†ã‚´ãƒªåˆ¥å•†å“æ•°
SELECT 
    c.name AS ã‚«ãƒ†ã‚´ãƒª,
    COUNT(p.id) AS å•†å“æ•°
FROM ec_categories c
LEFT JOIN ec_products p ON c.id = p.category_id
GROUP BY c.id, c.name
ORDER BY å•†å“æ•° DESC;

-- 2. å•†å“ä¸€è¦§ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼æƒ…å ±ä»˜ãï¼‰
SELECT 
    p.name AS å•†å“å,
    p.price AS ä¾¡æ ¼,
    COALESCE(AVG(r.rating), 0) AS å¹³å‡è©•ä¾¡,
    COUNT(r.id) AS ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°
FROM ec_products p
LEFT JOIN ec_reviews r ON p.id = r.product_id
GROUP BY p.id, p.name, p.price
ORDER BY å¹³å‡è©•ä¾¡ DESC, ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•° DESC;

-- 3. å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆä»®æƒ³ãƒ‡ãƒ¼ã‚¿ã§ï¼‰
-- æ³¨æ–‡ãŒã‚ã‚‹ã¨ä»®å®šã—ãŸã‚¯ã‚¨ãƒª
SELECT 
    p.name AS å•†å“å,
    SUM(oi.quantity) AS è²©å£²æ•°,
    SUM(oi.quantity * oi.price_at_order) AS å£²ä¸Šé‡‘é¡
FROM ec_order_items oi
JOIN ec_products p ON oi.product_id = p.id
GROUP BY p.id, p.name
ORDER BY å£²ä¸Šé‡‘é¡ DESC
LIMIT 10;

-- 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³¼å…¥å±¥æ­´
SELECT 
    u.name AS ãƒ¦ãƒ¼ã‚¶ãƒ¼å,
    o.id AS æ³¨æ–‡ID,
    o.total AS åˆè¨ˆé‡‘é¡,
    o.status AS ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹,
    GROUP_CONCAT(oi.product_name) AS å•†å“
FROM ec_users u
JOIN ec_orders o ON u.id = o.user_id
JOIN ec_order_items oi ON o.id = oi.order_id
GROUP BY u.id, u.name, o.id, o.total, o.status
ORDER BY o.ordered_at DESC;
EOF
```

### æ³¨æ–‡å‡¦ç†ã®ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£

```bash
docker exec -it mysql-practice mysql -u student -pstudentpass practice << 'EOF'
DELIMITER //

CREATE PROCEDURE create_order(IN p_user_id INT)
BEGIN
    DECLARE v_order_id INT;
    DECLARE v_subtotal DECIMAL(12,2);
    DECLARE v_tax DECIMAL(12,2);
    DECLARE v_total DECIMAL(12,2);
    
    START TRANSACTION;
    
    -- å°è¨ˆè¨ˆç®—
    SELECT SUM(p.price * ci.quantity) INTO v_subtotal
    FROM ec_cart_items ci
    JOIN ec_products p ON ci.product_id = p.id
    WHERE ci.user_id = p_user_id;
    
    IF v_subtotal IS NULL OR v_subtotal = 0 THEN
        ROLLBACK;
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™';
    END IF;
    
    SET v_tax = ROUND(v_subtotal * 0.1, 2);
    SET v_total = v_subtotal + v_tax;
    
    -- æ³¨æ–‡ä½œæˆ
    INSERT INTO ec_orders (user_id, subtotal, tax, total)
    VALUES (p_user_id, v_subtotal, v_tax, v_total);
    SET v_order_id = LAST_INSERT_ID();
    
    -- æ³¨æ–‡æ˜ç´°ä½œæˆ & åœ¨åº«æ¸›å°‘
    INSERT INTO ec_order_items (order_id, product_id, product_name, quantity, price_at_order)
    SELECT v_order_id, p.id, p.name, ci.quantity, p.price
    FROM ec_cart_items ci
    JOIN ec_products p ON ci.product_id = p.id
    WHERE ci.user_id = p_user_id;
    
    UPDATE ec_products p
    JOIN ec_cart_items ci ON p.id = ci.product_id
    SET p.stock = p.stock - ci.quantity
    WHERE ci.user_id = p_user_id;
    
    -- ã‚«ãƒ¼ãƒˆã‚¯ãƒªã‚¢
    DELETE FROM ec_cart_items WHERE user_id = p_user_id;
    
    COMMIT;
    SELECT v_order_id AS order_id, v_total AS total;
END //

DELIMITER ;

-- ãƒ†ã‚¹ãƒˆ
INSERT INTO ec_cart_items (user_id, product_id, quantity) VALUES (1, 1, 1), (1, 5, 2);
CALL create_order(1);
SELECT * FROM ec_orders;
SELECT * FROM ec_order_items;
EOF
```

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

```markdown
## ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ
- [ ] é©åˆ‡ãªä¸»ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹
- [ ] å¤–éƒ¨ã‚­ãƒ¼ã§å‚ç…§æ•´åˆæ€§ã‚’ä¿è¨¼
- [ ] NOT NULL åˆ¶ç´„ãŒå¿…è¦ãªåˆ—ã«è¨­å®š
- [ ] é©åˆ‡ãªãƒ‡ãƒ¼ã‚¿å‹ã‚’é¸æŠ
- [ ] é©åˆ‡ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ

## æ­£è¦åŒ–
- [ ] ç¬¬3æ­£è¦å½¢ã¾ã§æ­£è¦åŒ–
- [ ] å¿…è¦ã«å¿œã˜ãŸéæ­£è¦åŒ–

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- [ ] æ¤œç´¢æ¡ä»¶ã®åˆ—ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- [ ] çµåˆæ¡ä»¶ã®åˆ—ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- [ ] EXPLAIN ã§å®Ÿè¡Œè¨ˆç”»ã‚’ç¢ºèª

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- [ ] ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ãƒãƒƒã‚·ãƒ¥åŒ–
- [ ] å€‹äººæƒ…å ±ã®é©åˆ‡ãªç®¡ç†
- [ ] SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–

## é‹ç”¨
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨ˆç”»
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆ¦ç•¥
```

## ç†è§£åº¦ç¢ºèª

### å•é¡Œ

ECã‚µã‚¤ãƒˆã§ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ç´¯è¨ˆè³¼å…¥é‡‘é¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€ã‚’å–å¾—ã™ã‚‹ SQL ã¨ã—ã¦æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œã‹ã€‚

**A.**
```sql
SELECT user_id, SUM(total) 
FROM ec_orders 
ORDER BY SUM(total) DESC;
```

**B.**
```sql
SELECT u.name, SUM(o.total) AS total_spent
FROM ec_users u
JOIN ec_orders o ON u.id = o.user_id
WHERE o.status != 'cancelled'
GROUP BY u.id, u.name
ORDER BY total_spent DESC;
```

**C.**
```sql
SELECT u.name, o.total
FROM ec_users u, ec_orders o
WHERE u.id = o.user_id
ORDER BY o.total DESC;
```

**D.**
```sql
SELECT name, total FROM ec_orders
GROUP BY user_id
ORDER BY total DESC;
```

---

### è§£ç­”ãƒ»è§£èª¬

**æ­£è§£: B**

- **A.** SELECT ã« user_id ãŒã‚ã‚‹ãŒ GROUP BY ãŒãªã„ã€‚
- **B.** æ­£è§£ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä»¥å¤–ã®æ³¨æ–‡ã‚’é›†è¨ˆã€‚
- **C.** ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ãŒãªãã€å€‹åˆ¥ã®æ³¨æ–‡ã”ã¨ã«è¡¨ç¤ºã•ã‚Œã‚‹ã€‚
- **D.** æ–‡æ³•ã‚¨ãƒ©ãƒ¼ã€‚name ãŒ ec_orders ã«ãªã„ã€‚

---

## ğŸ‰ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åŸºç¤ å®Œäº†ï¼

### å­¦ç¿’ã®ç·ã¾ã¨ã‚

| Phase | å­¦ã‚“ã ã“ã¨ |
|-------|-----------|
| 0 | Docker ã§ MySQL ç’°å¢ƒæ§‹ç¯‰ |
| 1 | RDB ã®æ¦‚å¿µã€ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€  |
| 2 | SELECT, INSERT, UPDATE, DELETE |
| 3 | ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆã€æ­£è¦åŒ– |
| 4 | JOINã€é›†è¨ˆã€ã‚µãƒ–ã‚¯ã‚¨ãƒª |
| 5 | ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ |
| 6 | å®Ÿè·µãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ |

### æ¬¡ã«å­¦ã¶ã¹ãã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ 

- **Redisãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥** - DB è² è·è»½æ¸›
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°** - ã‚¯ã‚¨ãƒªæœ€é©åŒ–
- **NoSQL æ·±æ˜ã‚Š** - MongoDB, DynamoDB

---

**ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ğŸ—ƒï¸**
