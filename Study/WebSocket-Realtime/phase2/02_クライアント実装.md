# Phase 2-2: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…

## å­¦ç¿’ç›®æ¨™

ã“ã®å˜å…ƒã‚’çµ‚ãˆã‚‹ã¨ã€ä»¥ä¸‹ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š

- JavaScript ã§ WebSocket ã‚’å®Ÿè£…ã§ãã‚‹
- React ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ã‚’å®Ÿè£…ã§ãã‚‹
- å†æ¥ç¶šãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã§ãã‚‹

## JavaScript WebSocket API

```javascript
// åŸºæœ¬çš„ãªä½¿ã„æ–¹
const ws = new WebSocket('ws://localhost:8000/ws');

ws.onopen = () => console.log('Connected');
ws.onmessage = (event) => console.log('Received:', event.data);
ws.onerror = (error) => console.error('Error:', error);
ws.onclose = () => console.log('Disconnected');

ws.send('Hello!');
```

## ãƒãƒ³ã‚ºã‚ªãƒ³

### æ¼”ç¿’1: åŸºæœ¬çš„ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

```html
<!-- basic_client.html -->
<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Client</title>
    <style>
        #messages { list-style: none; padding: 0; }
        #messages li { padding: 5px; margin: 5px 0; background: #f0f0f0; }
        .system { color: gray; font-style: italic; }
    </style>
</head>
<body>
    <h1>WebSocket Client</h1>
    <div id="status">Connecting...</div>
    <input type="text" id="message" placeholder="Enter message">
    <button id="send">Send</button>
    <ul id="messages"></ul>

    <script>
        const statusEl = document.getElementById('status');
        const messagesEl = document.getElementById('messages');
        const messageInput = document.getElementById('message');
        const sendButton = document.getElementById('send');

        const ws = new WebSocket('ws://localhost:8000/ws');

        ws.onopen = () => {
            statusEl.textContent = 'Connected';
            statusEl.style.color = 'green';
        };

        ws.onmessage = (event) => {
            const li = document.createElement('li');
            li.textContent = event.data;
            messagesEl.appendChild(li);
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
        };

        ws.onclose = () => {
            statusEl.textContent = 'Disconnected';
            statusEl.style.color = 'red';
        };

        sendButton.onclick = () => {
            if (messageInput.value) {
                ws.send(messageInput.value);
                messageInput.value = '';
            }
        };

        messageInput.onkeypress = (e) => {
            if (e.key === 'Enter') sendButton.click();
        };
    </script>
</body>
</html>
```

### æ¼”ç¿’2: å†æ¥ç¶šãƒ­ã‚¸ãƒƒã‚¯

```javascript
// reconnecting_websocket.js
class ReconnectingWebSocket {
    constructor(url, options = {}) {
        this.url = url;
        this.reconnectInterval = options.reconnectInterval || 3000;
        this.maxReconnectAttempts = options.maxReconnectAttempts || 10;
        this.reconnectAttempts = 0;
        this.ws = null;
        
        this.onopen = () => {};
        this.onmessage = () => {};
        this.onclose = () => {};
        this.onerror = () => {};
        
        this.connect();
    }
    
    connect() {
        console.log('Connecting to', this.url);
        this.ws = new WebSocket(this.url);
        
        this.ws.onopen = (event) => {
            console.log('Connected');
            this.reconnectAttempts = 0;
            this.onopen(event);
        };
        
        this.ws.onmessage = (event) => {
            this.onmessage(event);
        };
        
        this.ws.onerror = (error) => {
            console.error('WebSocket error:', error);
            this.onerror(error);
        };
        
        this.ws.onclose = (event) => {
            console.log('Disconnected');
            this.onclose(event);
            this.reconnect();
        };
    }
    
    reconnect() {
        if (this.reconnectAttempts >= this.maxReconnectAttempts) {
            console.log('Max reconnect attempts reached');
            return;
        }
        
        this.reconnectAttempts++;
        console.log(`Reconnecting in ${this.reconnectInterval}ms... (attempt ${this.reconnectAttempts})`);
        
        setTimeout(() => {
            this.connect();
        }, this.reconnectInterval);
    }
    
    send(data) {
        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
            this.ws.send(data);
        } else {
            console.warn('WebSocket is not connected');
        }
    }
    
    close() {
        this.reconnectAttempts = this.maxReconnectAttempts;  // å†æ¥ç¶šã‚’æ­¢ã‚ã‚‹
        if (this.ws) {
            this.ws.close();
        }
    }
}

// ä½¿ç”¨ä¾‹
const ws = new ReconnectingWebSocket('ws://localhost:8000/ws');
ws.onmessage = (event) => console.log('Received:', event.data);
ws.send('Hello!');
```

### æ¼”ç¿’3: React Hook

```typescript
// useWebSocket.ts
import { useState, useEffect, useCallback, useRef } from 'react';

interface UseWebSocketOptions {
    reconnect?: boolean;
    reconnectInterval?: number;
}

export function useWebSocket(url: string, options: UseWebSocketOptions = {}) {
    const [isConnected, setIsConnected] = useState(false);
    const [messages, setMessages] = useState<string[]>([]);
    const wsRef = useRef<WebSocket | null>(null);
    const reconnectTimeoutRef = useRef<NodeJS.Timeout>();

    const { reconnect = true, reconnectInterval = 3000 } = options;

    const connect = useCallback(() => {
        const ws = new WebSocket(url);

        ws.onopen = () => {
            setIsConnected(true);
        };

        ws.onmessage = (event) => {
            setMessages((prev) => [...prev, event.data]);
        };

        ws.onclose = () => {
            setIsConnected(false);
            
            if (reconnect) {
                reconnectTimeoutRef.current = setTimeout(() => {
                    connect();
                }, reconnectInterval);
            }
        };

        wsRef.current = ws;
    }, [url, reconnect, reconnectInterval]);

    useEffect(() => {
        connect();

        return () => {
            if (reconnectTimeoutRef.current) {
                clearTimeout(reconnectTimeoutRef.current);
            }
            if (wsRef.current) {
                wsRef.current.close();
            }
        };
    }, [connect]);

    const sendMessage = useCallback((message: string) => {
        if (wsRef.current?.readyState === WebSocket.OPEN) {
            wsRef.current.send(message);
        }
    }, []);

    return { isConnected, messages, sendMessage };
}

// ä½¿ç”¨ä¾‹
// function Chat() {
//     const { isConnected, messages, sendMessage } = useWebSocket('ws://localhost:8000/ws');
//     return <div>...</div>;
// }
```

### æ¼”ç¿’4: React ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```tsx
// Chat.tsx
import React, { useState } from 'react';
import { useWebSocket } from './useWebSocket';

interface Message {
    type: 'message' | 'system';
    content: string;
    sender?: string;
    timestamp: string;
}

export function Chat({ userId }: { userId: string }) {
    const [input, setInput] = useState('');
    const { isConnected, messages, sendMessage } = useWebSocket(
        `ws://localhost:8000/ws/${userId}`
    );

    const handleSend = () => {
        if (input.trim()) {
            sendMessage(JSON.stringify({
                type: 'message',
                content: input
            }));
            setInput('');
        }
    };

    return (
        <div className="chat">
            <div className="status">
                {isConnected ? 'ğŸŸ¢ Connected' : 'ğŸ”´ Disconnected'}
            </div>
            
            <div className="messages">
                {messages.map((msg, i) => {
                    const parsed: Message = JSON.parse(msg);
                    return (
                        <div 
                            key={i} 
                            className={`message ${parsed.type}`}
                        >
                            {parsed.sender && <strong>{parsed.sender}: </strong>}
                            {parsed.content}
                        </div>
                    );
                })}
            </div>
            
            <div className="input">
                <input
                    value={input}
                    onChange={(e) => setInput(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                    placeholder="Type a message..."
                />
                <button onClick={handleSend}>Send</button>
            </div>
        </div>
    );
}
```

## ç†è§£åº¦ç¢ºèª

### å•é¡Œ

WebSocket ã®æ¥ç¶šçŠ¶æ…‹ãŒ OPEN ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ã©ã‚Œã‹ã€‚

**A.** ws.connected

**B.** ws.readyState === WebSocket.OPEN

**C.** ws.isOpen

**D.** ws.status === 'open'

---

### è§£ç­”ãƒ»è§£èª¬

**æ­£è§£: B**

```javascript
if (ws.readyState === WebSocket.OPEN) {
    ws.send(message);
}
```

readyState ã®å€¤:
- 0: CONNECTING
- 1: OPEN
- 2: CLOSING
- 3: CLOSED

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå®Ÿè£…ã‚’å­¦ã³ã¾ã—ãŸã€‚æ¬¡ã¯ãƒãƒ£ãƒƒãƒˆå®Ÿè£…ã‚’å­¦ã³ã¾ã—ã‚‡ã†ã€‚

**æ¬¡ã®å˜å…ƒ**: [Phase 3-1: ãƒãƒ£ãƒƒãƒˆå®Ÿè£…](../phase3/01_ãƒãƒ£ãƒƒãƒˆå®Ÿè£….md)
