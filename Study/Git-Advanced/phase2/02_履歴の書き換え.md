# Phase 2-2: 履歴の書き換え ～ きれいなコミット履歴を作る ～

## 学習目標

この単元を終えると、以下ができるようになります：

- git commit --amend で直前のコミットを修正できる
- git rebase -i で複数コミットを整理できる
- git reset で履歴を戻せる
- 安全に履歴を書き換えられる

## 概念解説

### なぜ履歴を書き換えるか

| Before | After |
|--------|-------|
| "WIP" | 意味のあるメッセージ |
| "fix typo" x 5 | 1つのまとまったコミット |
| 機密情報を含むコミット | 削除 |

### ⚠️ 重要な注意

**push 済みのコミットは書き換えない！**

チームメンバーの履歴と矛盾し、大混乱を招きます。

## ハンズオン

### 演習1: commit --amend

```bash
mkdir -p ~/git-practice/amend-demo
cd ~/git-practice/amend-demo
git init

# typo のあるコミット
echo "Hello Wrold" > hello.txt
git add . && git commit -m "Add hello"

# 直前のコミットを修正（メッセージ変更）
git commit --amend -m "Add hello.txt"

git log --oneline

# ファイル内容も修正したい場合
echo "Hello World" > hello.txt
git add hello.txt
git commit --amend --no-edit  # メッセージはそのまま

cat hello.txt
git log --oneline
```

### 演習2: rebase -i 基本

```bash
mkdir -p ~/git-practice/rebase-i-demo
cd ~/git-practice/rebase-i-demo
git init

# 複数のコミットを作成
echo "line 1" > file.txt && git add . && git commit -m "Add line 1"
echo "line 2" >> file.txt && git add . && git commit -m "Add line 2"
echo "line 3" >> file.txt && git add . && git commit -m "Add line 3"
echo "line 4" >> file.txt && git add . && git commit -m "Add line 4"

git log --oneline
# 例: 
# d4d4d4d Add line 4
# c3c3c3c Add line 3
# b2b2b2b Add line 2
# a1a1a1a Add line 1

# 最新3つのコミットを対話的に編集
git rebase -i HEAD~3
```

エディタが開いたら：
```
pick b2b2b2b Add line 2
pick c3c3c3c Add line 3
pick d4d4d4d Add line 4

# Commands:
# p, pick = コミットをそのまま使用
# r, reword = コミットメッセージを変更
# e, edit = コミットを編集（一時停止）
# s, squash = 前のコミットにまとめる（メッセージ編集）
# f, fixup = 前のコミットにまとめる（メッセージ破棄）
# d, drop = コミットを削除
```

### 演習3: squash でコミットをまとめる

```bash
cd ~/git-practice/rebase-i-demo

# WIP コミットを作る
git checkout -b feature/messy
echo "feature 1" > feature.txt && git add . && git commit -m "WIP"
echo "feature 2" >> feature.txt && git add . && git commit -m "WIP 2"
echo "feature 3" >> feature.txt && git add . && git commit -m "Fix typo"
echo "feature 4" >> feature.txt && git add . && git commit -m "Done"

git log --oneline

# まとめる
git rebase -i HEAD~4
```

エディタで：
```
pick xxx WIP
squash xxx WIP 2
squash xxx Fix typo
squash xxx Done
```

保存後、新しいコミットメッセージを入力：
```
feat: Add complete feature implementation
```

```bash
git log --oneline
# 1つのコミットにまとまっている
```

### 演習4: reword でメッセージ変更

```bash
cd ~/git-practice/rebase-i-demo
git checkout main

git rebase -i HEAD~2
```

エディタで：
```
reword xxx Add line 3
pick xxx Add line 4
```

保存後、新しいメッセージを入力：
```
feat: Add third line with validation
```

### 演習5: edit でコミット内容を変更

```bash
mkdir -p ~/git-practice/edit-demo
cd ~/git-practice/edit-demo
git init

echo "password=secret123" > config.txt
git add . && git commit -m "Add config"

echo "other content" > other.txt
git add . && git commit -m "Add other"

# config.txt から機密情報を削除したい
git rebase -i HEAD~2
```

エディタで：
```
edit xxx Add config
pick xxx Add other
```

```bash
# 一時停止状態になる
echo "password=REMOVED" > config.txt
git add config.txt
git commit --amend --no-edit
git rebase --continue

# 確認
git log --oneline -p
```

### 演習6: reset の種類

```bash
mkdir -p ~/git-practice/reset-demo
cd ~/git-practice/reset-demo
git init

echo "v1" > file.txt && git add . && git commit -m "Version 1"
echo "v2" > file.txt && git add . && git commit -m "Version 2"
echo "v3" > file.txt && git add . && git commit -m "Version 3"
echo "uncommitted" > file.txt && git add .

git log --oneline
git status
```

```bash
# --soft: コミットを取り消し、変更はステージング済み
git reset --soft HEAD~1
git status  # v3 の変更がステージング済み
git log --oneline

# 元に戻す
git commit -m "Version 3"
```

```bash
# --mixed（デフォルト）: コミットを取り消し、変更は作業ディレクトリ
git reset HEAD~1
git status  # v3 の変更がステージング解除
git log --oneline

# 元に戻す
git add . && git commit -m "Version 3"
```

```bash
# --hard: コミットを取り消し、変更も破棄（危険！）
git reset --hard HEAD~1
git status  # クリーン
git log --oneline
cat file.txt  # v2 に戻っている
```

### 演習7: reflog で復旧

```bash
cd ~/git-practice/reset-demo

# 間違って reset --hard してしまった！
git reset --hard HEAD~1
cat file.txt  # v1

# reflog で履歴を確認
git reflog
# 例:
# abc123 HEAD@{0}: reset: moving to HEAD~1
# def456 HEAD@{1}: commit: Version 2
# ...

# 復旧
git reset --hard HEAD@{1}
cat file.txt  # v2 に戻った！
```

## 安全な履歴書き換えルール

```markdown
## ✅ OK（書き換えて良い）
- まだ push していないコミット
- 自分しか使わないブランチ
- force push が許可されているブランチ

## ❌ NG（書き換えてはいけない）
- main/develop など共有ブランチ
- 他の人が pull した可能性のあるコミット
- タグが付いたコミット
```

## 理解度確認

### 問題

feature ブランチで「WIP」「typo fix」「WIP2」という3つのコミットを1つにまとめてから PR を出したい。まだ push していない場合、最も適切な方法はどれか。

**A.** `git commit --amend` を3回実行

**B.** `git rebase -i HEAD~3` で squash

**C.** `git reset --hard HEAD~3` で全削除

**D.** 新しいブランチを作り直す

---

### 解答・解説

**正解: B**

- **A.** --amend は直前のコミット1つしか修正できない。
- **B.** 正解。rebase -i で複数コミットを squash/fixup でまとめられる。
- **C.** 変更内容も消えてしまう。
- **D.** 履歴書き換えで対応でき、不要な手間。

---

## まとめ

| コマンド | 用途 |
|---------|------|
| commit --amend | 直前のコミットを修正 |
| rebase -i | 複数コミットを編集 |
| reset --soft | コミット取消（変更はステージング） |
| reset --mixed | コミット取消（変更は作業ディレクトリ） |
| reset --hard | コミット取消（変更も破棄） |
| reflog | 操作履歴から復旧 |

## 次のステップ

履歴の書き換えを学びました。次は PR の運用について学びましょう。

**次の単元**: [Phase 3-1: PR 運用](../phase3/01_PR運用.md)
