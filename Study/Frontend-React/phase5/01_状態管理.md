# Phase 5-1: çŠ¶æ…‹ç®¡ç†

## å­¦ç¿’ç›®æ¨™

ã“ã®å˜å…ƒã‚’çµ‚ãˆã‚‹ã¨ã€ä»¥ä¸‹ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š

- Context ã§çŠ¶æ…‹ã‚’å…±æœ‰ã§ãã‚‹
- Zustand ã§çŠ¶æ…‹ç®¡ç†ã§ãã‚‹
- é©åˆ‡ãªçŠ¶æ…‹ç®¡ç†ã‚’é¸æŠã§ãã‚‹

## Props drilling ã®å•é¡Œ

```mermaid
graph TB
    A[App] -->|user| B[Header]
    A -->|user| C[Content]
    B -->|user| D[UserMenu]
    C -->|user| E[Profile]
    E -->|user| F[Avatar]
```

æ·±ã„éšå±¤ã« Props ã‚’æ¸¡ã™ã®ã¯å¤§å¤‰...

## Context API

### åŸºæœ¬

```tsx
// src/contexts/AuthContext.tsx
import { createContext, useContext, useState, ReactNode } from 'react';

interface User {
    id: number;
    name: string;
    email: string;
}

interface AuthContextType {
    user: User | null;
    login: (email: string, password: string) => Promise<void>;
    logout: () => void;
    isAuthenticated: boolean;
}

const AuthContext = createContext<AuthContextType | null>(null);

export function AuthProvider({ children }: { children: ReactNode }) {
    const [user, setUser] = useState<User | null>(null);
    
    const login = async (email: string, password: string) => {
        // API å‘¼ã³å‡ºã—
        const response = await fetch('/api/login', {
            method: 'POST',
            body: JSON.stringify({ email, password })
        });
        const userData = await response.json();
        setUser(userData);
    };
    
    const logout = () => {
        setUser(null);
    };
    
    return (
        <AuthContext.Provider value={{
            user,
            login,
            logout,
            isAuthenticated: !!user
        }}>
            {children}
        </AuthContext.Provider>
    );
}

export function useAuth() {
    const context = useContext(AuthContext);
    if (!context) {
        throw new Error('useAuth must be used within AuthProvider');
    }
    return context;
}
```

```tsx
// main.tsx
import { AuthProvider } from './contexts/AuthContext';

ReactDOM.createRoot(document.getElementById('root')!).render(
    <AuthProvider>
        <App />
    </AuthProvider>
);
```

```tsx
// ã©ã“ã‹ã‚‰ã§ã‚‚ä½¿ãˆã‚‹
function UserMenu() {
    const { user, logout, isAuthenticated } = useAuth();
    
    if (!isAuthenticated) {
        return <Link to="/login">ãƒ­ã‚°ã‚¤ãƒ³</Link>;
    }
    
    return (
        <div>
            <span>{user?.name}</span>
            <button onClick={logout}>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    );
}
```

## Zustand

è»½é‡ã§ä½¿ã„ã‚„ã™ã„çŠ¶æ…‹ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

```bash
npm install zustand
```

### åŸºæœ¬

```tsx
// src/stores/useCounterStore.ts
import { create } from 'zustand';

interface CounterState {
    count: number;
    increment: () => void;
    decrement: () => void;
    reset: () => void;
}

const useCounterStore = create<CounterState>((set) => ({
    count: 0,
    increment: () => set((state) => ({ count: state.count + 1 })),
    decrement: () => set((state) => ({ count: state.count - 1 })),
    reset: () => set({ count: 0 }),
}));

export default useCounterStore;
```

```tsx
// ä½¿ç”¨
import useCounterStore from './stores/useCounterStore';

function Counter() {
    const { count, increment, decrement } = useCounterStore();
    
    return (
        <div>
            <p>{count}</p>
            <button onClick={decrement}>-</button>
            <button onClick={increment}>+</button>
        </div>
    );
}
```

### ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚«ãƒ¼ãƒˆ

```tsx
// src/stores/useCartStore.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface CartItem {
    id: number;
    name: string;
    price: number;
    quantity: number;
}

interface CartState {
    items: CartItem[];
    addItem: (item: Omit<CartItem, 'quantity'>) => void;
    removeItem: (id: number) => void;
    updateQuantity: (id: number, quantity: number) => void;
    clearCart: () => void;
    total: () => number;
}

const useCartStore = create<CartState>()(
    persist(
        (set, get) => ({
            items: [],
            
            addItem: (item) => set((state) => {
                const existing = state.items.find(i => i.id === item.id);
                if (existing) {
                    return {
                        items: state.items.map(i =>
                            i.id === item.id
                                ? { ...i, quantity: i.quantity + 1 }
                                : i
                        )
                    };
                }
                return { items: [...state.items, { ...item, quantity: 1 }] };
            }),
            
            removeItem: (id) => set((state) => ({
                items: state.items.filter(i => i.id !== id)
            })),
            
            updateQuantity: (id, quantity) => set((state) => ({
                items: state.items.map(i =>
                    i.id === id ? { ...i, quantity } : i
                )
            })),
            
            clearCart: () => set({ items: [] }),
            
            total: () => {
                return get().items.reduce(
                    (sum, item) => sum + item.price * item.quantity,
                    0
                );
            }
        }),
        {
            name: 'cart-storage',  // localStorage ã®ã‚­ãƒ¼
        }
    )
);

export default useCartStore;
```

```tsx
// src/components/Cart.tsx
import useCartStore from '../stores/useCartStore';

function Cart() {
    const { items, removeItem, updateQuantity, total, clearCart } = useCartStore();
    
    if (items.length === 0) {
        return <p>ã‚«ãƒ¼ãƒˆã¯ç©ºã§ã™</p>;
    }
    
    return (
        <div style={{ padding: '20px' }}>
            <h2>ğŸ›’ ã‚«ãƒ¼ãƒˆ</h2>
            {items.map(item => (
                <div 
                    key={item.id}
                    style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '16px',
                        padding: '12px',
                        borderBottom: '1px solid #eee'
                    }}
                >
                    <span style={{ flex: 1 }}>{item.name}</span>
                    <span>Â¥{item.price.toLocaleString()}</span>
                    <input
                        type="number"
                        value={item.quantity}
                        onChange={(e) => updateQuantity(item.id, Number(e.target.value))}
                        min={1}
                        style={{ width: '60px', padding: '4px' }}
                    />
                    <button onClick={() => removeItem(item.id)}>å‰Šé™¤</button>
                </div>
            ))}
            <div style={{ marginTop: '20px', textAlign: 'right' }}>
                <p style={{ fontSize: '24px', fontWeight: 'bold' }}>
                    åˆè¨ˆ: Â¥{total().toLocaleString()}
                </p>
                <button onClick={clearCart}>ã‚«ãƒ¼ãƒˆã‚’ç©ºã«ã™ã‚‹</button>
            </div>
        </div>
    );
}

export default Cart;
```

## çŠ¶æ…‹ç®¡ç†ã®é¸æŠ

| çŠ¶æ…‹ã®ç¨®é¡ | æ¨å¥¨ |
|-----------|------|
| ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆ1ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰ | useState |
| å…±æœ‰ï¼ˆè¦ªå­é–“ï¼‰ | Props |
| ã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼ˆèªè¨¼ãªã©ï¼‰ | Context or Zustand |
| è¤‡é›‘ãªã‚°ãƒ­ãƒ¼ãƒãƒ« | Zustand |
| ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ | TanStack Query |

## ç†è§£åº¦ç¢ºèª

### å•é¡Œ

Zustand ã§çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹æ­£ã—ã„æ–¹æ³•ã¯ã©ã‚Œã‹ã€‚

```tsx
const useStore = create((set) => ({
    count: 0,
    // ã©ã†æ›¸ãï¼Ÿ
}));
```

**A.** `increment: () => count++`

**B.** `increment: () => set({ count: count + 1 })`

**C.** `increment: () => set((state) => ({ count: state.count + 1 }))`

**D.** `increment: () => this.count++`

---

### è§£ç­”ãƒ»è§£èª¬

**æ­£è§£: C**

```tsx
increment: () => set((state) => ({ count: state.count + 1 }))
```

`set` é–¢æ•°ã«æ›´æ–°é–¢æ•°ã‚’æ¸¡ã™ã“ã¨ã§ã€ç¾åœ¨ã®çŠ¶æ…‹ã‚’åŸºã«æ–°ã—ã„çŠ¶æ…‹ã‚’ä½œæˆã—ã¾ã™ã€‚

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

çŠ¶æ…‹ç®¡ç†ã‚’å­¦ã³ã¾ã—ãŸã€‚æ¬¡ã¯ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒã‚’å­¦ã³ã¾ã—ã‚‡ã†ã€‚

**æ¬¡ã®å˜å…ƒ**: [Phase 5-2: ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒ](./02_ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒ.md)
