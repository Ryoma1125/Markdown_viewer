# Phase 1-2: クリーンコード ～ 読みやすいコードを書く ～

## 学習目標

この単元を終えると、以下ができるようになります：

- 適切な命名ができる
- 関数を適切なサイズに保てる
- コメントの適切な使い方を理解できる
- リファクタリングの手法を実践できる

## ハンズオン

### 演習1: 適切な命名

```python
# ❌ 悪い例
def calc(d):
    t = 0
    for i in d:
        t += i['p'] * i['q']
    return t

# ✅ 良い例
def calculate_order_total(order_items: list[dict]) -> float:
    total = 0
    for item in order_items:
        total += item['price'] * item['quantity']
    return total
```

**命名規則**

| 種類 | 規則 | 例 |
|------|------|-----|
| 変数 | 名詞、意図が明確 | user_count, is_active |
| 関数 | 動詞で始まる | get_user, calculate_tax |
| クラス | 名詞、PascalCase | UserRepository, OrderService |
| 定数 | 大文字+アンダースコア | MAX_RETRY_COUNT |
| bool | is/has/can で始まる | is_valid, has_permission |

```python
# ❌ 悪い命名
d = 86400  # 何の数値？
flag = True  # 何のフラグ？
data = get_data()  # 何のデータ？

# ✅ 良い命名
SECONDS_PER_DAY = 86400
is_user_authenticated = True
user_profile = get_user_profile(user_id)
```

### 演習2: 関数の設計

```python
# ❌ 悪い例：長すぎる関数
def process_order(order):
    # ユーザー検証
    user = db.query(f"SELECT * FROM users WHERE id = {order['user_id']}")
    if not user:
        raise ValueError("User not found")
    if not user['is_active']:
        raise ValueError("User is not active")
    
    # 在庫確認
    for item in order['items']:
        product = db.query(f"SELECT * FROM products WHERE id = {item['product_id']}")
        if product['stock'] < item['quantity']:
            raise ValueError(f"Insufficient stock for {product['name']}")
    
    # 価格計算
    total = 0
    for item in order['items']:
        product = db.query(f"SELECT * FROM products WHERE id = {item['product_id']}")
        total += product['price'] * item['quantity']
    
    # 割引適用
    if user['is_vip']:
        total *= 0.9
    
    # 注文作成
    # ... さらに続く
```

```python
# ✅ 良い例：小さな関数に分割
class OrderProcessor:
    def __init__(self, user_service, product_service, order_repository):
        self.user_service = user_service
        self.product_service = product_service
        self.order_repository = order_repository
    
    def process(self, order: dict) -> dict:
        user = self._validate_user(order['user_id'])
        self._validate_stock(order['items'])
        total = self._calculate_total(order['items'], user)
        return self._create_order(order, total)
    
    def _validate_user(self, user_id: int) -> dict:
        user = self.user_service.find_by_id(user_id)
        if not user:
            raise ValueError("User not found")
        if not user['is_active']:
            raise ValueError("User is not active")
        return user
    
    def _validate_stock(self, items: list[dict]) -> None:
        for item in items:
            if not self.product_service.has_stock(item['product_id'], item['quantity']):
                raise ValueError(f"Insufficient stock")
    
    def _calculate_total(self, items: list[dict], user: dict) -> float:
        subtotal = sum(
            self.product_service.get_price(item['product_id']) * item['quantity']
            for item in items
        )
        return self._apply_discount(subtotal, user)
    
    def _apply_discount(self, amount: float, user: dict) -> float:
        if user['is_vip']:
            return amount * 0.9
        return amount
```

### 演習3: コメントの使い方

```python
# ❌ 悪いコメント：コードを説明している
# ユーザーIDが1の場合
if user_id == 1:
    pass

# i をインクリメント
i += 1

# ユーザーを取得
user = get_user(id)
```

```python
# ✅ 良いコメント：WHY を説明している

# システム管理者は常にアクセス可能（セキュリティポリシー #123）
if user_id == ADMIN_USER_ID:
    return True

# パフォーマンス上の理由でバッチサイズを制限
# 1000件を超えるとメモリ使用量が急増する
BATCH_SIZE = 1000

# TODO: 認証APIのレート制限対応が必要（Issue #456）
# HACK: 一時的な回避策、次のリリースで修正予定
```

### 演習4: 早期リターン

```python
# ❌ 悪い例：深いネスト
def process_payment(order):
    if order:
        if order.is_valid():
            if order.user.has_payment_method():
                if order.total > 0:
                    # 実際の処理
                    return process(order)
                else:
                    raise ValueError("Invalid total")
            else:
                raise ValueError("No payment method")
        else:
            raise ValueError("Invalid order")
    else:
        raise ValueError("No order")
```

```python
# ✅ 良い例：早期リターン（ガード節）
def process_payment(order):
    if not order:
        raise ValueError("No order")
    
    if not order.is_valid():
        raise ValueError("Invalid order")
    
    if not order.user.has_payment_method():
        raise ValueError("No payment method")
    
    if order.total <= 0:
        raise ValueError("Invalid total")
    
    return process(order)
```

### 演習5: マジックナンバーの排除

```python
# ❌ 悪い例
def calculate_shipping(weight):
    if weight < 5:
        return 500
    elif weight < 10:
        return 800
    else:
        return 1200

def check_status(status):
    if status == 1:  # 何を意味する？
        pass
```

```python
# ✅ 良い例
from enum import Enum

# 定数として定義
LIGHT_PACKAGE_WEIGHT = 5  # kg
MEDIUM_PACKAGE_WEIGHT = 10  # kg

LIGHT_SHIPPING_FEE = 500
MEDIUM_SHIPPING_FEE = 800
HEAVY_SHIPPING_FEE = 1200

def calculate_shipping(weight: float) -> int:
    if weight < LIGHT_PACKAGE_WEIGHT:
        return LIGHT_SHIPPING_FEE
    elif weight < MEDIUM_PACKAGE_WEIGHT:
        return MEDIUM_SHIPPING_FEE
    else:
        return HEAVY_SHIPPING_FEE

# Enum で状態を表現
class OrderStatus(Enum):
    PENDING = 1
    PAID = 2
    SHIPPED = 3
    DELIVERED = 4

def check_status(status: OrderStatus):
    if status == OrderStatus.PENDING:
        pass
```

### 演習6: DRY 原則

```python
# ❌ 悪い例：重複コード
def create_user(name, email):
    if not name or len(name) < 2:
        raise ValueError("Name must be at least 2 characters")
    if not email or "@" not in email:
        raise ValueError("Invalid email")
    # 作成処理

def update_user(user_id, name, email):
    if not name or len(name) < 2:
        raise ValueError("Name must be at least 2 characters")
    if not email or "@" not in email:
        raise ValueError("Invalid email")
    # 更新処理
```

```python
# ✅ 良い例：共通化
class UserValidator:
    MIN_NAME_LENGTH = 2
    
    @staticmethod
    def validate_name(name: str) -> None:
        if not name or len(name) < UserValidator.MIN_NAME_LENGTH:
            raise ValueError(f"Name must be at least {UserValidator.MIN_NAME_LENGTH} characters")
    
    @staticmethod
    def validate_email(email: str) -> None:
        if not email or "@" not in email:
            raise ValueError("Invalid email")
    
    @classmethod
    def validate(cls, name: str, email: str) -> None:
        cls.validate_name(name)
        cls.validate_email(email)

def create_user(name: str, email: str):
    UserValidator.validate(name, email)
    # 作成処理

def update_user(user_id: int, name: str, email: str):
    UserValidator.validate(name, email)
    # 更新処理
```

## クリーンコードチェックリスト

```markdown
## 命名
- [ ] 変数名から意図が読み取れる
- [ ] 略語を避けている
- [ ] 一貫した命名規則

## 関数
- [ ] 20行以内に収まっている
- [ ] 1つのことだけ行う
- [ ] 引数は3つ以下

## 構造
- [ ] ネストは3段階以内
- [ ] 早期リターンを使用
- [ ] マジックナンバーを排除

## コメント
- [ ] コードで説明できることはコメントしない
- [ ] WHY を説明している
- [ ] TODO/FIXME は Issue と紐付け
```

## 理解度確認

### 問題

以下のコードの問題点として最も適切なものはどれか。

```python
def p(l):
    r = []
    for i in l:
        if i % 2 == 0:
            r.append(i)
    return r
```

**A.** ロジックが間違っている

**B.** 命名が不適切で意図が読み取れない

**C.** 関数が長すぎる

**D.** コメントがない

---

### 解答・解説

**正解: B**

- `p`, `l`, `r`, `i` などの1文字変数名から意図が読み取れない
- 改善例：

```python
def filter_even_numbers(numbers: list[int]) -> list[int]:
    return [n for n in numbers if n % 2 == 0]
```

---

## 次のステップ

クリーンコードの原則を学びました。次はデザインパターンを学びましょう。

**次の単元**: [Phase 2-1: 生成パターン](../phase2/01_生成パターン.md)
