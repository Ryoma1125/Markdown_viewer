# Phase 5-1: ç·ä»•ä¸Šã’ ï½ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®Ÿè·µ ï½

## å­¦ç¿’ç›®æ¨™

ã“ã®å˜å…ƒã‚’çµ‚ãˆã‚‹ã¨ã€ä»¥ä¸‹ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š

- æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ã£ã¦ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã§ãã‚‹
- ã‚³ãƒ¼ãƒ‰ã®è‡­ã„ï¼ˆCode Smellï¼‰ã‚’è­˜åˆ¥ã§ãã‚‹
- æ®µéšçš„ã«ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚’é€²ã‚ã‚‰ã‚Œã‚‹

## ç·åˆæ¼”ç¿’: ECã‚µã‚¤ãƒˆã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°

### Before: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å‰ã®ã‚³ãƒ¼ãƒ‰

```python
# âŒ å•é¡Œã ã‚‰ã‘ã®ã‚³ãƒ¼ãƒ‰
class OrderProcessor:
    def process_order(self, user_id, items, payment_type, card_info=None, 
                     paypal_email=None, shipping_type="standard"):
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
        import mysql.connector
        conn = mysql.connector.connect(host="localhost", user="root", password="root", database="shop")
        cursor = conn.cursor()
        cursor.execute(f"SELECT * FROM users WHERE id = {user_id}")
        user = cursor.fetchone()
        
        if not user:
            print("User not found")
            return None
        
        if user[5] == 0:  # is_active
            print("User is not active")
            return None
        
        # åœ¨åº«ç¢ºèªã¨ä¾¡æ ¼è¨ˆç®—
        total = 0
        for item in items:
            cursor.execute(f"SELECT * FROM products WHERE id = {item['product_id']}")
            product = cursor.fetchone()
            if product[4] < item['quantity']:  # stock
                print(f"Not enough stock for {product[1]}")
                return None
            total += product[3] * item['quantity']  # price * quantity
        
        # é…é€æ–™è¨ˆç®—
        if shipping_type == "standard":
            shipping = 500
            days = 5
        elif shipping_type == "express":
            shipping = 1000
            days = 2
        elif shipping_type == "same_day":
            shipping = 2000
            days = 0
        
        total += shipping
        
        # å‰²å¼•é©ç”¨
        if user[6] == 1:  # is_vip
            total *= 0.9
        
        # æ±ºæ¸ˆå‡¦ç†
        if payment_type == "credit_card":
            # ã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆ
            print(f"Charging card {card_info['number'][-4:]} for {total}")
            transaction_id = "CC" + str(int(time.time()))
        elif payment_type == "paypal":
            # PayPalæ±ºæ¸ˆ
            print(f"Charging PayPal {paypal_email} for {total}")
            transaction_id = "PP" + str(int(time.time()))
        else:
            print("Unknown payment type")
            return None
        
        # åœ¨åº«æ›´æ–°
        for item in items:
            cursor.execute(f"UPDATE products SET stock = stock - {item['quantity']} WHERE id = {item['product_id']}")
        
        # æ³¨æ–‡ä½œæˆ
        cursor.execute(f"INSERT INTO orders (user_id, total, status) VALUES ({user_id}, {total}, 'paid')")
        order_id = cursor.lastrowid
        
        # ãƒ¡ãƒ¼ãƒ«é€ä¿¡
        print(f"Sending confirmation email to {user[3]}")
        
        # Slacké€šçŸ¥
        print(f"Notifying Slack: New order #{order_id}")
        
        conn.commit()
        conn.close()
        
        return {"order_id": order_id, "total": total, "transaction_id": transaction_id}
```

### ã‚³ãƒ¼ãƒ‰ã®è‡­ã„ï¼ˆCode Smellï¼‰ã‚’è­˜åˆ¥

```python
# å•é¡Œç‚¹ãƒªã‚¹ãƒˆ
"""
1. å˜ä¸€è²¬ä»»ã®åŸå‰‡é•å
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œè¨¼
   - åœ¨åº«ç¢ºèª
   - ä¾¡æ ¼è¨ˆç®—
   - é…é€æ–™è¨ˆç®—
   - å‰²å¼•é©ç”¨
   - æ±ºæ¸ˆå‡¦ç†
   - åœ¨åº«æ›´æ–°
   - æ³¨æ–‡ä½œæˆ
   - é€šçŸ¥é€ä¿¡
   â†’ å…¨éƒ¨ãŒ1ã¤ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«ï¼

2. ä¾å­˜æ€§é€†è»¢ã®åŸå‰‡é•å
   - MySQLã«ç›´æ¥ä¾å­˜
   - æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹ã«ç›´æ¥ä¾å­˜
   - é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ã«ç›´æ¥ä¾å­˜

3. ã‚ªãƒ¼ãƒ—ãƒ³ãƒ»ã‚¯ãƒ­ãƒ¼ã‚ºãƒ‰ã®åŸå‰‡é•å
   - æ–°ã—ã„æ±ºæ¸ˆæ–¹æ³•ã‚’è¿½åŠ ã™ã‚‹ã¨ifæ–‡ã‚’ä¿®æ­£
   - æ–°ã—ã„é…é€æ–¹æ³•ã‚’è¿½åŠ ã™ã‚‹ã¨ifæ–‡ã‚’ä¿®æ­£

4. ãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼
   - user[5], user[6], product[3], product[4]
   - 500, 1000, 2000ï¼ˆé…é€æ–™ï¼‰
   - 0.9ï¼ˆVIPå‰²å¼•ç‡ï¼‰

5. SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³è„†å¼±æ€§
   - f-string ã§SQLæ§‹ç¯‰

6. ãƒ†ã‚¹ãƒˆä¸å¯èƒ½
   - å¤–éƒ¨ä¾å­˜ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰
"""
```

### After: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¾Œã®ã‚³ãƒ¼ãƒ‰

#### Step 1: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å®šç¾©

```python
# domain/entities.py
from dataclasses import dataclass, field
from datetime import datetime
from typing import List, Optional
from enum import Enum

class OrderStatus(Enum):
    PENDING = "pending"
    PAID = "paid"
    SHIPPED = "shipped"

@dataclass
class User:
    id: int
    name: str
    email: str
    is_active: bool
    is_vip: bool
    
    def validate_can_order(self):
        if not self.is_active:
            raise ValueError("User is not active")

@dataclass
class Product:
    id: int
    name: str
    price: float
    stock: int
    
    def has_stock(self, quantity: int) -> bool:
        return self.stock >= quantity
    
    def reduce_stock(self, quantity: int):
        if not self.has_stock(quantity):
            raise ValueError(f"Insufficient stock for {self.name}")
        self.stock -= quantity

@dataclass
class OrderItem:
    product: Product
    quantity: int
    
    @property
    def subtotal(self) -> float:
        return self.product.price * self.quantity

@dataclass
class Order:
    id: Optional[int]
    user: User
    items: List[OrderItem]
    shipping_cost: float
    status: OrderStatus = OrderStatus.PENDING
    created_at: datetime = field(default_factory=datetime.now)
    
    @property
    def subtotal(self) -> float:
        return sum(item.subtotal for item in self.items)
    
    @property
    def total(self) -> float:
        total = self.subtotal + self.shipping_cost
        if self.user.is_vip:
            total *= 0.9  # VIP 10% off
        return total
    
    def pay(self):
        if self.status != OrderStatus.PENDING:
            raise ValueError("Order is not pending")
        self.status = OrderStatus.PAID
```

#### Step 2: Strategy ãƒ‘ã‚¿ãƒ¼ãƒ³ã§é…é€ãƒ»æ±ºæ¸ˆã‚’æŠ½è±¡åŒ–

```python
# domain/strategies.py
from abc import ABC, abstractmethod
from dataclasses import dataclass

# é…é€æˆ¦ç•¥
@dataclass
class ShippingOption:
    cost: float
    estimated_days: int

class ShippingStrategy(ABC):
    @abstractmethod
    def calculate(self) -> ShippingOption:
        pass

class StandardShipping(ShippingStrategy):
    def calculate(self) -> ShippingOption:
        return ShippingOption(cost=500, estimated_days=5)

class ExpressShipping(ShippingStrategy):
    def calculate(self) -> ShippingOption:
        return ShippingOption(cost=1000, estimated_days=2)

class SameDayShipping(ShippingStrategy):
    def calculate(self) -> ShippingOption:
        return ShippingOption(cost=2000, estimated_days=0)

# æ±ºæ¸ˆæˆ¦ç•¥
@dataclass
class PaymentResult:
    success: bool
    transaction_id: str
    error_message: str = ""

class PaymentStrategy(ABC):
    @abstractmethod
    def pay(self, amount: float) -> PaymentResult:
        pass

class CreditCardPayment(PaymentStrategy):
    def __init__(self, card_number: str, expiry: str, cvv: str):
        self.card_number = card_number
        self.expiry = expiry
        self.cvv = cvv
    
    def pay(self, amount: float) -> PaymentResult:
        # å®Ÿéš›ã¯ã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆAPIã‚’å‘¼ã¶
        return PaymentResult(
            success=True,
            transaction_id=f"CC_{int(datetime.now().timestamp())}"
        )

class PayPalPayment(PaymentStrategy):
    def __init__(self, email: str):
        self.email = email
    
    def pay(self, amount: float) -> PaymentResult:
        # å®Ÿéš›ã¯PayPal APIã‚’å‘¼ã¶
        return PaymentResult(
            success=True,
            transaction_id=f"PP_{int(datetime.now().timestamp())}"
        )
```

#### Step 3: Repository ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã‚’æŠ½è±¡åŒ–

```python
# domain/repositories.py
from abc import ABC, abstractmethod
from typing import Optional, List

class UserRepository(ABC):
    @abstractmethod
    def find_by_id(self, user_id: int) -> Optional[User]:
        pass

class ProductRepository(ABC):
    @abstractmethod
    def find_by_id(self, product_id: int) -> Optional[Product]:
        pass
    
    @abstractmethod
    def save(self, product: Product) -> Product:
        pass

class OrderRepository(ABC):
    @abstractmethod
    def save(self, order: Order) -> Order:
        pass
```

#### Step 4: Observer ãƒ‘ã‚¿ãƒ¼ãƒ³ã§é€šçŸ¥ã‚’æŠ½è±¡åŒ–

```python
# domain/observers.py
from abc import ABC, abstractmethod

class OrderObserver(ABC):
    @abstractmethod
    def on_order_created(self, order: Order):
        pass

class EmailNotifier(OrderObserver):
    def on_order_created(self, order: Order):
        print(f"ğŸ“§ Sending confirmation email to {order.user.email}")

class SlackNotifier(OrderObserver):
    def on_order_created(self, order: Order):
        print(f"ğŸ’¬ Notifying Slack: New order #{order.id}")

class AnalyticsTracker(OrderObserver):
    def on_order_created(self, order: Order):
        print(f"ğŸ“Š Tracking order #{order.id} in analytics")
```

#### Step 5: Use Case ã‚’å®Ÿè£…

```python
# application/create_order.py
from dataclasses import dataclass
from typing import List

@dataclass
class CreateOrderInput:
    user_id: int
    items: List[dict]  # [{"product_id": 1, "quantity": 2}]
    shipping_strategy: ShippingStrategy
    payment_strategy: PaymentStrategy

@dataclass
class CreateOrderOutput:
    order_id: int
    total: float
    transaction_id: str

class CreateOrderUseCase:
    def __init__(
        self,
        user_repository: UserRepository,
        product_repository: ProductRepository,
        order_repository: OrderRepository,
        observers: List[OrderObserver] = None
    ):
        self.user_repository = user_repository
        self.product_repository = product_repository
        self.order_repository = order_repository
        self.observers = observers or []
    
    def execute(self, input_data: CreateOrderInput) -> CreateOrderOutput:
        # 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ãƒ»æ¤œè¨¼
        user = self.user_repository.find_by_id(input_data.user_id)
        if not user:
            raise ValueError("User not found")
        user.validate_can_order()
        
        # 2. å•†å“å–å¾—ãƒ»åœ¨åº«ç¢ºèª
        order_items = []
        for item_data in input_data.items:
            product = self.product_repository.find_by_id(item_data["product_id"])
            if not product:
                raise ValueError(f"Product {item_data['product_id']} not found")
            if not product.has_stock(item_data["quantity"]):
                raise ValueError(f"Insufficient stock for {product.name}")
            order_items.append(OrderItem(product=product, quantity=item_data["quantity"]))
        
        # 3. é…é€æ–™è¨ˆç®—
        shipping_option = input_data.shipping_strategy.calculate()
        
        # 4. æ³¨æ–‡ä½œæˆ
        order = Order(
            id=None,
            user=user,
            items=order_items,
            shipping_cost=shipping_option.cost
        )
        
        # 5. æ±ºæ¸ˆå‡¦ç†
        payment_result = input_data.payment_strategy.pay(order.total)
        if not payment_result.success:
            raise ValueError(f"Payment failed: {payment_result.error_message}")
        
        # 6. åœ¨åº«æ›´æ–°
        for item in order_items:
            item.product.reduce_stock(item.quantity)
            self.product_repository.save(item.product)
        
        # 7. æ³¨æ–‡ã‚’æ”¯æ‰•ã„æ¸ˆã¿ã«æ›´æ–°ã—ã¦ä¿å­˜
        order.pay()
        saved_order = self.order_repository.save(order)
        
        # 8. é€šçŸ¥
        for observer in self.observers:
            observer.on_order_created(saved_order)
        
        return CreateOrderOutput(
            order_id=saved_order.id,
            total=saved_order.total,
            transaction_id=payment_result.transaction_id
        )
```

#### Step 6: ä½¿ç”¨ä¾‹

```python
# main.py
def main():
    # Infrastructureï¼ˆå®Ÿéš›ã¯DBã«æ¥ç¶šï¼‰
    user_repo = InMemoryUserRepository()
    product_repo = InMemoryProductRepository()
    order_repo = InMemoryOrderRepository()
    
    # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
    user_repo.save(User(id=1, name="ç”°ä¸­", email="tanaka@example.com", is_active=True, is_vip=True))
    product_repo.save(Product(id=1, name="ãƒãƒ¼ãƒˆPC", price=100000, stock=10))
    product_repo.save(Product(id=2, name="ãƒã‚¦ã‚¹", price=3000, stock=50))
    
    # Observers
    observers = [
        EmailNotifier(),
        SlackNotifier(),
        AnalyticsTracker()
    ]
    
    # Use Case
    create_order = CreateOrderUseCase(
        user_repository=user_repo,
        product_repository=product_repo,
        order_repository=order_repo,
        observers=observers
    )
    
    # æ³¨æ–‡ä½œæˆ
    result = create_order.execute(CreateOrderInput(
        user_id=1,
        items=[
            {"product_id": 1, "quantity": 1},
            {"product_id": 2, "quantity": 2}
        ],
        shipping_strategy=ExpressShipping(),
        payment_strategy=CreditCardPayment("4111111111111111", "12/25", "123")
    ))
    
    print(f"\nâœ… Order created!")
    print(f"   Order ID: {result.order_id}")
    print(f"   Total: Â¥{result.total:,.0f}")
    print(f"   Transaction: {result.transaction_id}")

main()
```

## ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°åŠ¹æœã¾ã¨ã‚

| è¦³ç‚¹ | Before | After |
|------|--------|-------|
| è¡Œæ•° | 80è¡Œã®1ãƒ¡ã‚½ãƒƒãƒ‰ | è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†å‰² |
| ãƒ†ã‚¹ãƒˆ | ä¸å¯èƒ½ | ãƒ¢ãƒƒã‚¯ã§å®¹æ˜“ |
| æ‹¡å¼µæ€§ | ifæ–‡è¿½åŠ  | ã‚¯ãƒ©ã‚¹è¿½åŠ ã®ã¿ |
| ä¿å®ˆæ€§ | ä½ã„ | é«˜ã„ |
| å†åˆ©ç”¨æ€§ | ãªã— | å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†åˆ©ç”¨å¯ |

## ç†è§£åº¦ç¢ºèª

### å•é¡Œ

æ–°ã—ã„æ±ºæ¸ˆæ–¹æ³•ã€Œã‚³ãƒ³ãƒ“ãƒ‹æ‰•ã„ã€ã‚’è¿½åŠ ã™ã‚‹å ´åˆã€ã©ã“ã‚’å¤‰æ›´ã™ã¹ãã‹ã€‚

**A.** CreateOrderUseCase ã« if æ–‡ã‚’è¿½åŠ 

**B.** PaymentStrategy ã‚’å®Ÿè£…ã—ãŸ ConvenienceStorePayment ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆ

**C.** Order ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä¿®æ­£

**D.** ã™ã¹ã¦ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ä¿®æ­£

---

### è§£ç­”ãƒ»è§£èª¬

**æ­£è§£: B**

Strategy ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚Šã€æ–°ã—ã„æ±ºæ¸ˆæ–¹æ³•ã¯ `PaymentStrategy` ã‚’å®Ÿè£…ã—ãŸã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§ã™ã€‚

```python
class ConvenienceStorePayment(PaymentStrategy):
    def __init__(self, store_code: str):
        self.store_code = store_code
    
    def pay(self, amount: float) -> PaymentResult:
        # ã‚³ãƒ³ãƒ“ãƒ‹æ‰•ã„å‡¦ç†
        return PaymentResult(
            success=True,
            transaction_id=f"CVS_{self.store_code}_{int(datetime.now().timestamp())}"
        )
```

æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã¯ä¸€åˆ‡å¤‰æ›´ä¸è¦ã§ã™ï¼

---

## ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ å®Œäº†ï¼

ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ ã‚’å®Œäº†ã—ã¾ã—ãŸã€‚

### å­¦ã‚“ã ã“ã¨

1. **SOLID åŸå‰‡** - è‰¯ã„è¨­è¨ˆã®åŸºæœ¬
2. **ã‚¯ãƒªãƒ¼ãƒ³ã‚³ãƒ¼ãƒ‰** - èª­ã¿ã‚„ã™ã„ã‚³ãƒ¼ãƒ‰
3. **ç”Ÿæˆãƒ‘ã‚¿ãƒ¼ãƒ³** - Factory, Singleton, Builder
4. **æ§‹é€ ãƒ‘ã‚¿ãƒ¼ãƒ³** - Adapter, Decorator, Facade
5. **æŒ¯ã‚‹èˆã„ãƒ‘ã‚¿ãƒ¼ãƒ³** - Strategy, Observer, Command
6. **å®Ÿè·µãƒ‘ã‚¿ãƒ¼ãƒ³** - Repository, DTO, DI
7. **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£** - ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã€ã‚¯ãƒªãƒ¼ãƒ³

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

- å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨ã—ã¦ã¿ã‚‹
- DDDï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³é§†å‹•è¨­è¨ˆï¼‰ã‚’å­¦ã¶
- ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’å­¦ã¶
