# Phase 4-2: コードカバレッジ

## 学習目標

この単元を終えると、以下ができるようになります：

- コードカバレッジの種類を説明できる
- pytest-cov でカバレッジを計測できる
- 適切なカバレッジ目標を設定できる

## 概念解説

### カバレッジとは

**コードカバレッジ** = テストがコードのどれだけを実行したかの指標

### カバレッジの種類

| 種類 | 説明 | 例 |
|------|------|-----|
| 行カバレッジ | 実行された行の割合 | 80% |
| 分岐カバレッジ | 通過した分岐の割合 | 75% |
| 関数カバレッジ | 呼び出された関数の割合 | 90% |
| 条件カバレッジ | 評価された条件の割合 | 70% |

### 例

```python
def get_discount(age, is_member):
    if age < 12:           # 分岐1
        discount = 0.2
    elif age >= 65:        # 分岐2
        discount = 0.15
    else:                  # 分岐3
        discount = 0
    
    if is_member:          # 分岐4
        discount += 0.1
    
    return discount
```

完全な分岐カバレッジには以下のテストが必要：
- `age < 12, is_member=True`
- `age < 12, is_member=False`
- `age >= 65, is_member=True`
- `age >= 65, is_member=False`
- `12 <= age < 65, is_member=True`
- `12 <= age < 65, is_member=False`

## ハンズオン

### 演習1: pytest-cov の基本

```bash
# インストール
pip install pytest-cov
```

```python
# calculator.py
def add(a, b):
    return a + b

def subtract(a, b):
    return a - b

def divide(a, b):
    if b == 0:
        raise ValueError("Cannot divide by zero")
    return a / b

def multiply(a, b):
    return a * b
```

```python
# test_calculator.py
from calculator import add, subtract, divide

def test_add():
    assert add(1, 2) == 3

def test_subtract():
    assert subtract(5, 3) == 2

def test_divide():
    assert divide(10, 2) == 5

# multiply はテストなし
```

```bash
# カバレッジ計測
pytest --cov=calculator test_calculator.py

# 出力例:
# Name            Stmts   Miss  Cover
# -----------------------------------
# calculator.py       9      2    78%
# -----------------------------------
# TOTAL               9      2    78%
```

### 演習2: カバレッジレポート

```bash
# HTMLレポート生成
pytest --cov=calculator --cov-report=html test_calculator.py

# htmlcov/index.html をブラウザで開く

# 詳細な行表示
pytest --cov=calculator --cov-report=term-missing test_calculator.py

# 出力例:
# Name            Stmts   Miss  Cover   Missing
# ---------------------------------------------
# calculator.py       9      2    78%   10, 13
```

### 演習3: 最低カバレッジの設定

```bash
# カバレッジが80%未満なら失敗
pytest --cov=calculator --cov-fail-under=80

# pyproject.toml での設定
```

```toml
# pyproject.toml
[tool.pytest.ini_options]
addopts = "--cov=src --cov-report=term-missing --cov-fail-under=80"

[tool.coverage.run]
source = ["src"]
omit = ["tests/*", "*/__init__.py"]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "if TYPE_CHECKING:",
    "raise NotImplementedError",
]
```

### 演習4: 除外設定

```python
# some_module.py
def important_function():
    return "tested"

def debug_function():  # pragma: no cover
    """デバッグ用、カバレッジから除外"""
    print("debug info")

if __name__ == "__main__":  # pragma: no cover
    # スクリプト直接実行時のみ
    debug_function()
```

```ini
# .coveragerc
[run]
source = src
omit =
    */tests/*
    */__init__.py
    */migrations/*

[report]
exclude_lines =
    pragma: no cover
    def __repr__
    raise AssertionError
    raise NotImplementedError
    if __name__ == .__main__.:
    if TYPE_CHECKING:
```

### 演習5: 分岐カバレッジ

```bash
# 分岐カバレッジを有効化
pytest --cov=calculator --cov-branch test_calculator.py
```

```python
# user_service.py
def get_user_type(age, is_premium):
    if age < 18:
        user_type = "minor"
    else:
        user_type = "adult"
    
    if is_premium:
        user_type += "_premium"
    
    return user_type
```

```python
# test_user_service.py - 行カバレッジ100%だが分岐は不完全
def test_adult_premium():
    assert get_user_type(25, True) == "adult_premium"

# 行はすべて通るが、以下の分岐がテストされていない：
# - age < 18 の場合
# - is_premium = False の場合
```

### 演習6: CI での活用

```yaml
# .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run tests with coverage
        run: |
          pytest --cov=src --cov-report=xml --cov-fail-under=80
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
```

## カバレッジの目標値

| 目標 | 考え方 |
|------|-------|
| 100% | 現実的でない、過剰なテストになる |
| 80-90% | 多くのプロジェクトの目標 |
| 70-80% | 最低限の目安 |

### カバレッジの限界

```python
# 100% カバレッジでもバグがある例
def divide(a, b):
    return a / b  # b=0 のテストがないとバグ

def test_divide():
    assert divide(10, 2) == 5  # 100% カバレッジ達成
    # でも b=0 のケースはテストしていない
```

**カバレッジはテストの品質を保証しない**

## ベストプラクティス

| 項目 | 推奨 |
|------|------|
| 目標 | 80%以上を目安に |
| 重点 | 重要なビジネスロジック |
| 除外 | 自動生成コード、デバッグ用 |
| CI | 毎回計測、閾値設定 |

## 理解度確認

### 問題

コードカバレッジが100%であることが示すものはどれか。

**A.** コードにバグがないこと

**B.** すべての行が少なくとも1回実行されたこと

**C.** すべてのエッジケースがテストされたこと

**D.** テストが十分であること

---

### 解答・解説

**正解: B**

100%のカバレッジは「すべての行が実行された」ことを示すだけで：
- バグがないことは保証しない
- エッジケースの網羅は保証しない
- テストの品質は保証しない

カバレッジは指標の一つに過ぎません。

---

## 次のステップ

カバレッジを学びました。次は総仕上げです。

**次の単元**: [Phase 5-1: 総仕上げ](../phase5/01_総仕上げ.md)
