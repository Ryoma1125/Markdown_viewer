# Phase 5-2: ãƒãƒ«ãƒã‚³ãƒ³ãƒ†ãƒŠæ§‹æˆ ï½ å®Ÿè·µçš„ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ§‹ç¯‰ ï½

## å­¦ç¿’ç›®æ¨™

ã“ã®å˜å…ƒã‚’çµ‚ãˆã‚‹ã¨ã€ä»¥ä¸‹ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š

- å®Ÿè·µçš„ãª Web ã‚¢ãƒ—ãƒªæ§‹æˆï¼ˆFrontend + Backend + DB + Cacheï¼‰ã‚’æ§‹ç¯‰ã§ãã‚‹
- ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’è¨­å®šã—ã¦ä¿¡é ¼æ€§ã‚’å‘ä¸Šã§ãã‚‹
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’åˆ†é›¢ã—ã¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’é«˜ã‚ã‚‰ã‚Œã‚‹
- ãƒ­ã‚°ç®¡ç†ã‚„ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ã‚’è¨­å®šã§ãã‚‹

## æ¦‚å¿µè§£èª¬

### å®Ÿè·µçš„ãªãƒãƒ«ãƒã‚³ãƒ³ãƒ†ãƒŠæ§‹æˆ

```mermaid
graph TB
    Client[ğŸŒ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ] --> Nginx[nginx<br/>ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·]
    
    subgraph "Frontend Network"
        Nginx --> Frontend[React App<br/>:3000]
    end
    
    subgraph "Backend Network"
        Nginx --> API[Flask API<br/>:5000]
        API --> DB[(MySQL<br/>:3306)]
        API --> Cache[(Redis<br/>:6379)]
    end
    
    style Client fill:#f9f
    style Nginx fill:#90EE90
    style Frontend fill:#87CEEB
    style API fill:#FFB6C1
    style DB fill:#DDA0DD
    style Cache fill:#F0E68C
```

### AWS ã§ä¾‹ãˆã‚‹ã¨...

| Compose æ§‹æˆ | AWS æ§‹æˆ |
|-------------|---------|
| nginx ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚· | ALB (Application Load Balancer) |
| Frontend ã‚³ãƒ³ãƒ†ãƒŠ | S3 + CloudFront |
| API ã‚³ãƒ³ãƒ†ãƒŠ | ECS / Lambda |
| MySQL | RDS |
| Redis | ElastiCache |

## ãƒãƒ³ã‚ºã‚ªãƒ³

### æ¼”ç¿’1: å®Œå…¨ãª Web ã‚¢ãƒ—ãƒªæ§‹æˆ

```bash
mkdir -p ~/docker-practice/fullstack-app
cd ~/docker-practice/fullstack-app

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
mkdir -p frontend backend nginx
```

**Backend (Flask API):**

```bash
cat << 'EOF' > backend/app.py
from flask import Flask, jsonify, request
from flask_cors import CORS
import redis
import mysql.connector
import os
import time
import json

app = Flask(__name__)
CORS(app)

# Redis æ¥ç¶š
def get_redis():
    return redis.Redis(host='redis', port=6379, decode_responses=True)

# MySQL æ¥ç¶š
def get_db():
    for i in range(30):
        try:
            return mysql.connector.connect(
                host='db',
                user='root',
                password=os.getenv('MYSQL_ROOT_PASSWORD', 'secret'),
                database='myapp'
            )
        except:
            time.sleep(2)
    raise Exception("DB connection failed")

@app.route('/api/health')
def health():
    return jsonify({"status": "healthy"})

@app.route('/api/items', methods=['GET'])
def get_items():
    r = get_redis()
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª
    cached = r.get('items')
    if cached:
        return jsonify({"source": "cache", "items": json.loads(cached)})
    
    # DB ã‹ã‚‰å–å¾—
    conn = get_db()
    cursor = conn.cursor(dictionary=True)
    cursor.execute("SELECT * FROM items")
    items = cursor.fetchall()
    conn.close()
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ï¼ˆ60ç§’ï¼‰
    r.setex('items', 60, json.dumps(items))
    
    return jsonify({"source": "database", "items": items})

@app.route('/api/items', methods=['POST'])
def create_item():
    data = request.json
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("INSERT INTO items (name, price) VALUES (%s, %s)", 
                   (data['name'], data['price']))
    conn.commit()
    conn.close()
    
    # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
    get_redis().delete('items')
    
    return jsonify({"message": "Created"}), 201

@app.route('/api/init')
def init_db():
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS items (
            id INT AUTO_INCREMENT PRIMARY KEY,
            name VARCHAR(100),
            price INT
        )
    """)
    cursor.execute("DELETE FROM items")
    cursor.execute("INSERT INTO items (name, price) VALUES ('Apple', 100)")
    cursor.execute("INSERT INTO items (name, price) VALUES ('Banana', 80)")
    cursor.execute("INSERT INTO items (name, price) VALUES ('Orange', 120)")
    conn.commit()
    conn.close()
    get_redis().delete('items')
    return jsonify({"message": "Initialized"})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
EOF

cat << 'EOF' > backend/requirements.txt
flask==3.0.0
flask-cors==4.0.0
redis==5.0.1
mysql-connector-python==8.2.0
EOF

cat << 'EOF' > backend/Dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY app.py .
EXPOSE 5000
CMD ["python", "app.py"]
EOF
```

**Frontend (ã‚·ãƒ³ãƒ—ãƒ«ãª HTML/JS):**

```bash
cat << 'EOF' > frontend/index.html
<!DOCTYPE html>
<html>
<head>
    <title>Docker Fullstack App</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .item { padding: 10px; margin: 5px 0; background: #f0f0f0; border-radius: 5px; }
        .source { color: #666; font-size: 12px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input { padding: 8px; margin: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ³ Docker Fullstack App</h1>
    
    <div>
        <button onclick="initDB()">Initialize DB</button>
        <button onclick="loadItems()">Load Items</button>
    </div>
    
    <h2>Add Item</h2>
    <input type="text" id="name" placeholder="Name">
    <input type="number" id="price" placeholder="Price">
    <button onclick="addItem()">Add</button>
    
    <h2>Items</h2>
    <div id="source" class="source"></div>
    <div id="items"></div>
    
    <script>
        const API = '/api';
        
        async function loadItems() {
            const res = await fetch(`${API}/items`);
            const data = await res.json();
            document.getElementById('source').textContent = `Source: ${data.source}`;
            document.getElementById('items').innerHTML = data.items
                .map(i => `<div class="item">${i.name}: Â¥${i.price}</div>`)
                .join('');
        }
        
        async function addItem() {
            const name = document.getElementById('name').value;
            const price = parseInt(document.getElementById('price').value);
            await fetch(`${API}/items`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name, price})
            });
            loadItems();
        }
        
        async function initDB() {
            await fetch(`${API}/init`);
            loadItems();
        }
        
        loadItems();
    </script>
</body>
</html>
EOF

cat << 'EOF' > frontend/Dockerfile
FROM nginx:alpine
COPY index.html /usr/share/nginx/html/
EOF
```

**Nginx (ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·):**

```bash
cat << 'EOF' > nginx/nginx.conf
events {
    worker_connections 1024;
}

http {
    upstream frontend {
        server frontend:80;
    }
    
    upstream backend {
        server backend:5000;
    }
    
    server {
        listen 80;
        
        # Frontend
        location / {
            proxy_pass http://frontend;
        }
        
        # Backend API
        location /api {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}
EOF

cat << 'EOF' > nginx/Dockerfile
FROM nginx:alpine
COPY nginx.conf /etc/nginx/nginx.conf
EOF
```

**Docker Compose:**

```bash
cat << 'EOF' > docker-compose.yml
version: '3.8'

services:
  nginx:
    build: ./nginx
    ports:
      - "8080:80"
    depends_on:
      - frontend
      - backend
    networks:
      - frontend-net
      - backend-net
    restart: unless-stopped

  frontend:
    build: ./frontend
    networks:
      - frontend-net
    restart: unless-stopped

  backend:
    build: ./backend
    environment:
      MYSQL_ROOT_PASSWORD: secret
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - backend-net
    restart: unless-stopped

  db:
    image: mysql:8
    environment:
      MYSQL_ROOT_PASSWORD: secret
      MYSQL_DATABASE: myapp
    volumes:
      - db-data:/var/lib/mysql
    networks:
      - backend-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: redis:alpine
    networks:
      - backend-net
    restart: unless-stopped

networks:
  frontend-net:
  backend-net:

volumes:
  db-data:
EOF

# èµ·å‹•
docker compose up -d --build

# ãƒ­ã‚°ã‚’ç¢ºèª
docker compose logs -f

# ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹
# http://localhost:8080

# Initialize DB ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
# Load Items ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆ1å›ç›®: databaseã€2å›ç›®: cacheï¼‰

# åœæ­¢
docker compose down -v
```

### æ¼”ç¿’2: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã¨ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™

```bash
mkdir -p ~/docker-practice/healthcheck
cd ~/docker-practice/healthcheck

cat << 'EOF' > docker-compose.yml
version: '3.8'

services:
  web:
    image: nginx
    ports:
      - "8080:80"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    restart: unless-stopped

  db:
    image: mysql:8
    environment:
      MYSQL_ROOT_PASSWORD: secret
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
    restart: unless-stopped
EOF

# èµ·å‹•
docker compose up -d

# ãƒ˜ãƒ«ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
docker compose ps
# STATUS ã« (healthy) ã¨è¡¨ç¤ºã•ã‚Œã‚‹

# è©³ç´°ç¢ºèª
docker inspect healthcheck-web-1 --format='{{json .State.Health}}' | python3 -m json.tool

# ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨çŠ¶æ³
docker stats --no-stream

# åœæ­¢
docker compose down
```

### æ¼”ç¿’3: ãƒ­ã‚°ç®¡ç†

```bash
mkdir -p ~/docker-practice/logging
cd ~/docker-practice/logging

cat << 'EOF' > docker-compose.yml
version: '3.8'

services:
  web:
    image: nginx
    ports:
      - "8080:80"
    logging:
      driver: json-file
      options:
        max-size: "10m"    # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«æœ€å¤§ã‚µã‚¤ã‚º
        max-file: "3"      # ä¿æŒã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«æ•°

  app:
    image: python:3.11-slim
    command: python -c "import time; import sys; [print(f'Log {i}', flush=True) or time.sleep(1) for i in range(1000)]"
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"
EOF

# èµ·å‹•
docker compose up -d

# ãƒ­ã‚°ã‚’ç¢ºèª
docker compose logs -f app

# æœ€æ–°100è¡Œ
docker compose logs --tail 100 app

# ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ã
docker compose logs -t app

# åœæ­¢
docker compose down
```

### æ¼”ç¿’4: é–‹ç™º/æœ¬ç•ªç’°å¢ƒã®åˆ‡ã‚Šæ›¿ãˆ

```bash
mkdir -p ~/docker-practice/multi-stage-env
cd ~/docker-practice/multi-stage-env

# å…±é€šè¨­å®š
cat << 'EOF' > docker-compose.yml
version: '3.8'

services:
  web:
    image: nginx
    
  db:
    image: mysql:8
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-default}
      MYSQL_DATABASE: ${DB_NAME:-myapp}
    volumes:
      - db-data:/var/lib/mysql

volumes:
  db-data:
EOF

# é–‹ç™ºç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
cat << 'EOF' > docker-compose.dev.yml
version: '3.8'

services:
  web:
    ports:
      - "8080:80"
    volumes:
      - ./html:/usr/share/nginx/html
    environment:
      - DEBUG=true

  db:
    ports:
      - "3306:3306"  # é–‹ç™ºæ™‚ã¯ãƒãƒ¼ãƒˆå…¬é–‹

  adminer:
    image: adminer
    ports:
      - "9000:8080"
    depends_on:
      - db
EOF

# æœ¬ç•ªç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
cat << 'EOF' > docker-compose.prod.yml
version: '3.8'

services:
  web:
    ports:
      - "80:80"
    restart: always
    deploy:
      resources:
        limits:
          memory: 256M

  db:
    restart: always
    deploy:
      resources:
        limits:
          memory: 1G
    # ãƒãƒ¼ãƒˆã¯å…¬é–‹ã—ãªã„ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
EOF

# é–‹ç™ºç’°å¢ƒå¤‰æ•°
cat << 'EOF' > .env.dev
DB_PASSWORD=dev_password
DB_NAME=dev_db
EOF

# æœ¬ç•ªç’°å¢ƒå¤‰æ•°
cat << 'EOF' > .env.prod
DB_PASSWORD=super_secure_password_123
DB_NAME=production_db
EOF

mkdir -p html
echo "<h1>Development</h1>" > html/index.html

# é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
docker compose --env-file .env.dev -f docker-compose.yml -f docker-compose.dev.yml up -d
docker compose ps
curl http://localhost:8080
# http://localhost:9000 ã§ Adminer ã«ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

docker compose down

# æœ¬ç•ªãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
docker compose --env-file .env.prod -f docker-compose.yml -f docker-compose.prod.yml up -d
docker compose ps
curl http://localhost:80

docker compose down -v
```

## ç¾å ´ã§ã‚ˆãã‚ã‚‹è½ã¨ã—ç©´

### 1. ã‚³ãƒ³ãƒ†ãƒŠé–“é€šä¿¡ã§ãƒ›ã‚¹ãƒˆåã‚’é–“é•ãˆã‚‹

```yaml
# âŒ localhost ã¯å„ã‚³ãƒ³ãƒ†ãƒŠè‡ªèº«ã‚’æŒ‡ã™
DATABASE_URL: mysql://localhost:3306/myapp

# âœ… ã‚µãƒ¼ãƒ“ã‚¹åã‚’ä½¿ã†
DATABASE_URL: mysql://db:3306/myapp
```

### 2. èµ·å‹•é †åºã®å•é¡Œ

```yaml
# âŒ depends_on ã ã‘ã§ã¯ä¸ååˆ†
depends_on:
  - db

# âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’çµ„ã¿åˆã‚ã›ã‚‹
depends_on:
  db:
    condition: service_healthy
```

### 3. ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³

```yaml
# âŒ ãƒ›ã‚¹ãƒˆã¨ã‚³ãƒ³ãƒ†ãƒŠã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç•°ãªã‚‹
volumes:
  - ./data:/app/data

# âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æŒ‡å®šã™ã‚‹ã‹ã€æ¨©é™ã‚’èª¿æ•´
user: "1000:1000"
# ã¾ãŸã¯ Dockerfile ã§é©åˆ‡ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¨­å®š
```

## ç†è§£åº¦ç¢ºèª

### å•é¡Œ

ä»¥ä¸‹ã® docker-compose.yml ã§ã€web ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ db ã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶šã™ã‚‹éš›ã®æ­£ã—ã„ãƒ›ã‚¹ãƒˆåã¯ã©ã‚Œã‹ã€‚

```yaml
services:
  web:
    image: myapp
    depends_on:
      - db
  db:
    image: mysql:8
    container_name: mysql-server
```

**A.** localhost

**B.** mysql-server

**C.** db

**D.** 172.17.0.2

---

### è§£ç­”ãƒ»è§£èª¬

**æ­£è§£: C**

Docker Compose ã®åŒä¸€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†…ã§ã¯ã€**ã‚µãƒ¼ãƒ“ã‚¹å**ãŒãƒ›ã‚¹ãƒˆåã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™ã€‚

- **A.** èª¤ã‚Šã€‚localhost ã¯å„ã‚³ãƒ³ãƒ†ãƒŠè‡ªèº«ã‚’æŒ‡ã—ã¾ã™ã€‚
- **B.** èª¤ã‚Šã€‚container_name ã¯ Docker CLI ã§ã®è­˜åˆ¥åã§ã‚ã‚Šã€DNS åã¨ã¯ç•°ãªã‚Šã¾ã™ã€‚ã‚µãƒ¼ãƒ“ã‚¹åãŒå„ªå…ˆã•ã‚Œã¾ã™ã€‚
- **C.** æ­£è§£ã€‚ã‚µãƒ¼ãƒ“ã‚¹åã€Œdbã€ã§ä»–ã®ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰æ¥ç¶šã§ãã¾ã™ã€‚
- **D.** èª¤ã‚Šã€‚IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å‹•çš„ã«å¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã™ã¹ãã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

---

## ã¾ã¨ã‚

| æ¦‚å¿µ | èª¬æ˜ |
|------|------|
| ãƒãƒ«ãƒã‚³ãƒ³ãƒ†ãƒŠ | å½¹å‰²ã”ã¨ã«ã‚³ãƒ³ãƒ†ãƒŠã‚’åˆ†é›¢ |
| ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†é›¢ | frontend-net / backend-net |
| ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ | èµ·å‹•å®Œäº†ã‚’ç¢ºèª |
| ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ | CPU/ãƒ¡ãƒ¢ãƒªã‚’åˆ¶å¾¡ |
| ç’°å¢ƒåˆ†é›¢ | dev/prod ã§è¨­å®šã‚’åˆ‡ã‚Šæ›¿ãˆ |

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

å®Ÿè·µçš„ãªãƒãƒ«ãƒã‚³ãƒ³ãƒ†ãƒŠæ§‹æˆãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼æ¬¡ã¯ Dockerfile ã®æœ€é©åŒ–ã‚’å­¦ã³ã¾ã—ã‚‡ã†ã€‚

**æ¬¡ã®å˜å…ƒ**: [Phase 6-1: Dockerfile æœ€é©åŒ– ï½ æœ¬ç•ªå“è³ªã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œã‚‹ ï½](../phase6/01_Dockerfileæœ€é©åŒ–.md)
