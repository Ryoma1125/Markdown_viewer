import{Gn as e,I as t,Mt as n,Nt as r,Wn as i,cn as a,mn as o,pn as s,wn as c,xn as l}from"./index-PJ0TmLvI.js";import"./reduce-DauDZIpp.js";import"./flatten-BrsxrPBL.js";import{t as u}from"./graphlib-Bjscn8VW.js";import{t as d}from"./dagre-CopDfQar.js";import"./chunk-55IACEB6-EudKf52f.js";import"./chunk-QN33PNHL-Bx7ZdXzs.js";import{i as f,n as p,t as m}from"./chunk-DI55MBZ5-B1p_gkCp.js";var h=i(e=>e.append(`circle`).attr(`class`,`start-state`).attr(`r`,l().state.sizeUnit).attr(`cx`,l().state.padding+l().state.sizeUnit).attr(`cy`,l().state.padding+l().state.sizeUnit),`drawStartState`),g=i(e=>e.append(`line`).style(`stroke`,`grey`).style(`stroke-dasharray`,`3`).attr(`x1`,l().state.textHeight).attr(`class`,`divider`).attr(`x2`,l().state.textHeight*2).attr(`y1`,0).attr(`y2`,0),`drawDivider`),_=i((e,t)=>{let n=e.append(`text`).attr(`x`,2*l().state.padding).attr(`y`,l().state.textHeight+2*l().state.padding).attr(`font-size`,l().state.fontSize).attr(`class`,`state-title`).text(t.id),r=n.node().getBBox();return e.insert(`rect`,`:first-child`).attr(`x`,l().state.padding).attr(`y`,l().state.padding).attr(`width`,r.width+2*l().state.padding).attr(`height`,r.height+2*l().state.padding).attr(`rx`,l().state.radius),n},`drawSimpleState`),v=i((e,t)=>{let n=i(function(e,t,n){let r=e.append(`tspan`).attr(`x`,2*l().state.padding).text(t);n||r.attr(`dy`,l().state.textHeight)},`addTspan`),r=e.append(`text`).attr(`x`,2*l().state.padding).attr(`y`,l().state.textHeight+1.3*l().state.padding).attr(`font-size`,l().state.fontSize).attr(`class`,`state-title`).text(t.descriptions[0]).node().getBBox(),a=r.height,o=e.append(`text`).attr(`x`,l().state.padding).attr(`y`,a+l().state.padding*.4+l().state.dividerMargin+l().state.textHeight).attr(`class`,`state-description`),s=!0,c=!0;t.descriptions.forEach(function(e){s||(n(o,e,c),c=!1),s=!1});let u=e.append(`line`).attr(`x1`,l().state.padding).attr(`y1`,l().state.padding+a+l().state.dividerMargin/2).attr(`y2`,l().state.padding+a+l().state.dividerMargin/2).attr(`class`,`descr-divider`),d=o.node().getBBox(),f=Math.max(d.width,r.width);return u.attr(`x2`,f+3*l().state.padding),e.insert(`rect`,`:first-child`).attr(`x`,l().state.padding).attr(`y`,l().state.padding).attr(`width`,f+2*l().state.padding).attr(`height`,d.height+a+2*l().state.padding).attr(`rx`,l().state.radius),e},`drawDescrState`),y=i((e,t,n)=>{let r=l().state.padding,i=2*l().state.padding,a=e.node().getBBox(),o=a.width,s=a.x,c=e.append(`text`).attr(`x`,0).attr(`y`,l().state.titleShift).attr(`font-size`,l().state.fontSize).attr(`class`,`state-title`).text(t.id),u=c.node().getBBox().width+i,d=Math.max(u,o);d===o&&(d+=i);let f,p=e.node().getBBox();t.doc,f=s-r,u>o&&(f=(o-d)/2+r),Math.abs(s-p.x)<r&&u>o&&(f=s-(u-o)/2);let m=1-l().state.textHeight;return e.insert(`rect`,`:first-child`).attr(`x`,f).attr(`y`,m).attr(`class`,n?`alt-composit`:`composit`).attr(`width`,d).attr(`height`,p.height+l().state.textHeight+l().state.titleShift+1).attr(`rx`,`0`),c.attr(`x`,f+r),u<=o&&c.attr(`x`,s+(d-i)/2-u/2+r),e.insert(`rect`,`:first-child`).attr(`x`,f).attr(`y`,l().state.titleShift-l().state.textHeight-l().state.padding).attr(`width`,d).attr(`height`,l().state.textHeight*3).attr(`rx`,l().state.radius),e.insert(`rect`,`:first-child`).attr(`x`,f).attr(`y`,l().state.titleShift-l().state.textHeight-l().state.padding).attr(`width`,d).attr(`height`,p.height+3+2*l().state.textHeight).attr(`rx`,l().state.radius),e},`addTitleAndBox`),b=i(e=>(e.append(`circle`).attr(`class`,`end-state-outer`).attr(`r`,l().state.sizeUnit+l().state.miniPadding).attr(`cx`,l().state.padding+l().state.sizeUnit+l().state.miniPadding).attr(`cy`,l().state.padding+l().state.sizeUnit+l().state.miniPadding),e.append(`circle`).attr(`class`,`end-state-inner`).attr(`r`,l().state.sizeUnit).attr(`cx`,l().state.padding+l().state.sizeUnit+2).attr(`cy`,l().state.padding+l().state.sizeUnit+2)),`drawEndState`),x=i((e,t)=>{let n=l().state.forkWidth,r=l().state.forkHeight;if(t.parentId){let e=n;n=r,r=e}return e.append(`rect`).style(`stroke`,`black`).style(`fill`,`black`).attr(`width`,n).attr(`height`,r).attr(`x`,l().state.padding).attr(`y`,l().state.padding)},`drawForkJoinState`),S=i((e,t,n,r)=>{let i=0,a=r.append(`text`);a.style(`text-anchor`,`start`),a.attr(`class`,`noteText`);let o=e.replace(/\r\n/g,`<br/>`);o=o.replace(/\n/g,`<br/>`);let c=o.split(s.lineBreakRegex),u=1.25*l().state.noteMargin;for(let e of c){let r=e.trim();if(r.length>0){let e=a.append(`tspan`);if(e.text(r),u===0){let t=e.node().getBBox();u+=t.height}i+=u,e.attr(`x`,t+l().state.noteMargin),e.attr(`y`,n+i+1.25*l().state.noteMargin)}}return{textWidth:a.node().getBBox().width,textHeight:i}},`_drawLongText`),C=i((e,t)=>{t.attr(`class`,`state-note`);let n=t.append(`rect`).attr(`x`,0).attr(`y`,l().state.padding),{textWidth:r,textHeight:i}=S(e,0,0,t.append(`g`));return n.attr(`height`,i+2*l().state.noteMargin),n.attr(`width`,r+l().state.noteMargin*2),n},`drawNote`),w=i(function(e,t){let n=t.id,r={id:n,label:t.id,width:0,height:0},i=e.append(`g`).attr(`id`,n).attr(`class`,`stateGroup`);t.type===`start`&&h(i),t.type===`end`&&b(i),(t.type===`fork`||t.type===`join`)&&x(i,t),t.type===`note`&&C(t.note.text,i),t.type===`divider`&&g(i),t.type===`default`&&t.descriptions.length===0&&_(i,t),t.type===`default`&&t.descriptions.length>0&&v(i,t);let a=i.node().getBBox();return r.width=a.width+2*l().state.padding,r.height=a.height+2*l().state.padding,r},`drawState`),T=0,E=i(function(a,o,u){let d=i(function(e){switch(e){case m.relationType.AGGREGATION:return`aggregation`;case m.relationType.EXTENSION:return`extension`;case m.relationType.COMPOSITION:return`composition`;case m.relationType.DEPENDENCY:return`dependency`}},`getRelationType`);o.points=o.points.filter(e=>!Number.isNaN(e.y));let f=o.points,p=r().x(function(e){return e.x}).y(function(e){return e.y}).curve(n),h=a.append(`path`).attr(`d`,p(f)).attr(`id`,`edge`+T).attr(`class`,`transition`),g=``;if(l().state.arrowMarkerAbsolute&&(g=c(!0)),h.attr(`marker-end`,`url(`+g+`#`+d(m.relationType.DEPENDENCY)+`End)`),u.title!==void 0){let n=a.append(`g`).attr(`class`,`stateLabel`),{x:r,y:i}=t.calcLabelPosition(o.points),c=s.getRows(u.title),d=0,f=[],p=0,m=0;for(let t=0;t<=c.length;t++){let a=n.append(`text`).attr(`text-anchor`,`middle`).text(c[t]).attr(`x`,r).attr(`y`,i+d),o=a.node().getBBox();p=Math.max(p,o.width),m=Math.min(m,o.x),e.info(o.x,r,i+d),d===0&&(d=a.node().getBBox().height,e.info(`Title height`,d,i)),f.push(a)}let h=d*c.length;if(c.length>1){let e=(c.length-1)*d*.5;f.forEach((t,n)=>t.attr(`y`,i+n*d-e)),h=d*c.length}let g=n.node().getBBox();n.insert(`rect`,`:first-child`).attr(`class`,`box`).attr(`x`,r-p/2-l().state.padding/2).attr(`y`,i-h/2-l().state.padding/2-3.5).attr(`width`,p+l().state.padding).attr(`height`,h+l().state.padding),e.info(g)}T++},`drawEdge`),D,O={},k=i(function(){},`setConf`),A=i(function(e){e.append(`defs`).append(`marker`).attr(`id`,`dependencyEnd`).attr(`refX`,19).attr(`refY`,7).attr(`markerWidth`,20).attr(`markerHeight`,28).attr(`orient`,`auto`).append(`path`).attr(`d`,`M 19,7 L9,13 L14,7 L9,1 Z`)},`insertMarkers`),j=i(function(t,n,r,i){D=l().state;let s=l().securityLevel,c;s===`sandbox`&&(c=a(`#i`+n));let u=a(s===`sandbox`?c.nodes()[0].contentDocument.body:`body`),d=s===`sandbox`?c.nodes()[0].contentDocument:document;e.debug(`Rendering diagram `+t);let f=u.select(`[id='${n}']`);A(f),N(i.db.getRootDoc(),f,void 0,!1,u,d,i);let p=D.padding,m=f.node().getBBox(),h=m.width+p*2,g=m.height+p*2;o(f,g,h*1.75,D.useMaxWidth),f.attr(`viewBox`,`${m.x-D.padding}  ${m.y-D.padding} `+h+` `+g)},`draw`),M=i(e=>e?e.length*D.fontSizeFactor:1,`getLabelWidth`),N=i((t,n,r,i,a,o,c)=>{let l=new u({compound:!0,multigraph:!0}),f,p=!0;for(f=0;f<t.length;f++)if(t[f].stmt===`relation`){p=!1;break}r?l.setGraph({rankdir:`LR`,multigraph:!0,compound:!0,ranker:`tight-tree`,ranksep:p?1:D.edgeLengthFactor,nodeSep:p?1:50,isMultiGraph:!0}):l.setGraph({rankdir:`TB`,multigraph:!0,compound:!0,ranksep:p?1:D.edgeLengthFactor,nodeSep:p?1:50,ranker:`tight-tree`,isMultiGraph:!0}),l.setDefaultEdgeLabel(function(){return{}});let m=c.db.getStates(),h=c.db.getRelations(),g=Object.keys(m);for(let e of g){let t=m[e];r&&(t.parentId=r);let s;if(t.doc){let e=n.append(`g`).attr(`id`,t.id).attr(`class`,`stateGroup`);s=N(t.doc,e,t.id,!i,a,o,c);{e=y(e,t,i);let n=e.node().getBBox();s.width=n.width,s.height=n.height+D.padding/2,O[t.id]={y:D.compositTitleSize}}}else s=w(n,t,l);if(t.note){let e=w(n,{descriptions:[],id:t.id+`-note`,note:t.note,type:`note`},l);t.note.position===`left of`?(l.setNode(s.id+`-note`,e),l.setNode(s.id,s)):(l.setNode(s.id,s),l.setNode(s.id+`-note`,e)),l.setParent(s.id,s.id+`-group`),l.setParent(s.id+`-note`,s.id+`-group`)}else l.setNode(s.id,s)}e.debug(`Count=`,l.nodeCount(),l);let _=0;h.forEach(function(t){_++,e.debug(`Setting edge`,t),l.setEdge(t.id1,t.id2,{relation:t,width:M(t.title),height:D.labelHeight*s.getRows(t.title).length,labelpos:`c`},`id`+_)}),d(l),e.debug(`Graph after layout`,l.nodes());let v=n.node();l.nodes().forEach(function(t){t!==void 0&&l.node(t)!==void 0?(e.warn(`Node `+t+`: `+JSON.stringify(l.node(t))),a.select(`#`+v.id+` #`+t).attr(`transform`,`translate(`+(l.node(t).x-l.node(t).width/2)+`,`+(l.node(t).y+(O[t]?O[t].y:0)-l.node(t).height/2)+` )`),a.select(`#`+v.id+` #`+t).attr(`data-x-shift`,l.node(t).x-l.node(t).width/2),o.querySelectorAll(`#`+v.id+` #`+t+` .divider`).forEach(e=>{let t=e.parentElement,n=0,r=0;t&&(t.parentElement&&(n=t.parentElement.getBBox().width),r=parseInt(t.getAttribute(`data-x-shift`),10),Number.isNaN(r)&&(r=0)),e.setAttribute(`x1`,0-r+8),e.setAttribute(`x2`,n-r-8)})):e.debug(`No Node `+t+`: `+JSON.stringify(l.node(t)))});let b=v.getBBox();l.edges().forEach(function(t){t!==void 0&&l.edge(t)!==void 0&&(e.debug(`Edge `+t.v+` -> `+t.w+`: `+JSON.stringify(l.edge(t))),E(n,l.edge(t),l.edge(t).relation))}),b=v.getBBox();let x={id:r||`root`,label:r||`root`,width:0,height:0};return x.width=b.width+2*D.padding,x.height=b.height+2*D.padding,e.debug(`Doc rendered`,x,l),x},`renderDoc`),P={parser:p,get db(){return new m(1)},renderer:{setConf:k,draw:j},styles:f,init:i(e=>{e.state||={},e.state.arrowMarkerAbsolute=e.arrowMarkerAbsolute},`init`)};export{P as diagram};